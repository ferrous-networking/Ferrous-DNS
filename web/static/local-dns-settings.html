<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local DNS - Ferrous DNS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s
        }

        .btn-primary { background: var(--color-primary); color: white }
        .btn-primary:hover { background: #2563EB }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary) }
        .btn-secondary:hover { background: var(--border-color) }
        .btn-danger { background: var(--color-error); color: white }
        .btn-danger:hover { background: #DC2626 }

        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s
        }

        .btn-icon:hover { background: var(--bg-tertiary); color: var(--text-primary) }

        .input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box
        }

        .input:focus { outline: none; border-color: var(--color-primary) }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block
        }

        .badge-blue { background: rgba(59,130,246,0.1); color: #3B82F6 }
        .badge-purple { background: rgba(168,85,247,0.1); color: #A855F7 }

        .table { width: 100%; border-collapse: collapse }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color)
        }

        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle
        }

        .table tbody tr:hover { background: var(--bg-tertiary) }

        .form-group { margin-bottom: 16px }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary)
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px
        }

        .tab-btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: -1px
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary)
        }

        .tab-btn:hover { color: var(--text-primary) }
    </style>
</head>
<body x-data="localDnsApp()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span></div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span>
        </div>
        <div class="status-item">
            <i data-lucide="server" style="width:12px;height:12px;color:var(--text-tertiary)"></i>
            <span x-text="`${records.length} local record${records.length === 1 ? '' : 's'}`"></span>
        </div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item"><i data-lucide="file-text" class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item active">
                <i data-lucide="server" class="nav-icon"></i>
                <span>Local DNS</span>
            </a>
            <a href="/settings.html" class="nav-item">
                <i data-lucide="settings" class="nav-icon"></i>
                <span>Settings</span>
            </a>
        </div>
    </nav>
</aside>

<main style="padding:24px">
    <div style="margin-bottom:24px">
        <h1 style="font-size:28px;font-weight:700;margin-bottom:4px;color:var(--text-primary)">Local DNS</h1>
        <p style="font-size:14px;color:var(--text-secondary)">Manage local DNS records for devices on your network</p>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active">
            DNS Records
            <span x-text="records.length" style="margin-left:8px;padding:2px 8px;border-radius:12px;font-size:12px;background:var(--bg-tertiary);color:var(--text-secondary)">0</span>
        </button>
    </div>

    <!-- DNS RECORDS -->
    <div>

        <div style="margin-bottom:24px">
            <div class="card" style="padding:24px">
                <h2 style="font-size:18px;font-weight:700;margin:0 0 16px;color:var(--text-primary)" x-text="editingRecord ? 'Edit DNS Record' : 'Add DNS Record'"></h2>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label class="form-label">Hostname <span style="color:var(--color-error)">*</span></label>
                        <input type="text" class="input" x-model="form.hostname" placeholder="e.g. server">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Domain <span style="color:var(--text-tertiary);font-weight:400">(optional)</span></label>
                        <input type="text" class="input" x-model="form.domain" placeholder="e.g. local">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label class="form-label">IP Address <span style="color:var(--color-error)">*</span></label>
                        <input type="text" class="input" x-model="form.ip" placeholder="e.g. 10.0.1.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="input" x-model="form.record_type">
                            <option value="A">A (IPv4)</option>
                            <option value="AAAA">AAAA (IPv6)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">TTL (seconds)</label>
                        <input type="number" class="input" x-model="form.ttl" placeholder="300">
                    </div>
                </div>
                <div style="display:flex;gap:12px">
                    <button class="btn btn-primary" @click="editingRecord ? updateRecord() : addRecord()" x-text="editingRecord ? 'Update Record' : 'Add Record'"></button>
                    <button class="btn btn-secondary" @click="cancelEdit()" x-text="editingRecord ? 'Cancel' : 'Clear'"></button>
                </div>
                <div x-show="addError" x-text="addError"
                     style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);color:var(--color-error);border-radius:8px;font-size:14px"></div>

                <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border-color)">
                    <p style="font-size:13px;color:var(--text-secondary);margin:0 0 6px">Records are stored in <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;font-family:monospace;font-size:12px">ferrous-dns.toml</code> and cached permanently in memory.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:0;font-style:italic">Changes are applied immediately and resolved in &lt;0.1ms. The config file can be version-controlled with Git.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <table class="table">
                <thead>
                <tr>
                    <th>FQDN</th>
                    <th>IP Address</th>
                    <th>Type</th>
                    <th>TTL</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="record in records" :key="record.fqdn">
                    <tr>
                        <td>
                            <span style="font-family:monospace;font-size:13px;color:var(--text-primary)" x-text="record.fqdn"></span>
                        </td>
                        <td>
                            <span style="font-family:monospace;font-size:13px;color:var(--text-primary)" x-text="record.ip"></span>
                        </td>
                        <td>
                            <span class="badge" :class="record.record_type === 'A' ? 'badge-blue' : 'badge-purple'" x-text="record.record_type"></span>
                        </td>
                        <td>
                            <span style="color:var(--text-secondary);font-size:14px" x-text="record.ttl + 's'"></span>
                        </td>
                        <td>
                            <div style="display:flex;gap:4px">
                                <button @click="editRecord(record)" class="btn-icon" title="Edit" style="color:var(--text-secondary)">
                                    <i data-lucide="pencil" style="width:16px;height:16px"></i>
                                </button>
                                <button @click="deleteRecord(record.id)" class="btn-icon" title="Delete" style="color:var(--color-error)">
                                    <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                <tr x-show="records.length === 0">
                    <td colspan="5" style="text-align:center;padding:48px;color:var(--text-secondary)">
                        <i data-lucide="server" style="width:48px;height:48px;margin-bottom:16px;display:block;margin-left:auto;margin-right:auto"></i>
                        <p style="margin:0">No DNS records yet. Add one above to get started.</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<script>
    function localDnsApp() {
        return {
            theme: localStorage.getItem('theme') || 'light',
            stats: {queries_total: 0},
            records: [],
            newRecord: {hostname: '', domain: '', ip: '', record_type: 'A', ttl: 300},
            editingRecord: null,
            addError: '',
            _ctrl: {},
            _pollId: null,
            async init() {
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadRecords(), this.loadStats()]);
                this.startPolling();
                scheduleLucide(100);
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.stopPolling();
                    else this.startPolling();
                });
            },
            switchTab(tab) {
                this.activeTab = tab;
                this.$nextTick(() => scheduleLucide());
            },
            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                scheduleLucide();
            },
            startPolling() {
                this.stopPolling();
                this._pollId = setInterval(() => this.loadStats(), 5000);
            },
            stopPolling() {
                clearInterval(this._pollId);
                this._pollId = null;
            },
            async loadStats() {
                this._ctrl.stats?.abort();
                this._ctrl.stats = new AbortController();
                try {
                    const r = await fetch('/api/stats', {signal: this._ctrl.stats.signal});
                    if (r.ok) this.stats = await r.json();
                } catch (e) {
                    if (e.name !== 'AbortError') console.error(e);
                }
            },
            get form() {
                return this.editingRecord ?? this.newRecord;
            },
            async loadRecords() {
                try {
                    const r = await fetch('/api/local-records');
                    if (r.ok) this.records = await r.json();
                } catch (e) {
                    console.error(e);
                }
            },
            editRecord(record) {
                this.editingRecord = {
                    id: record.id,
                    hostname: record.hostname,
                    domain: record.domain ?? '',
                    ip: record.ip,
                    record_type: record.record_type,
                    ttl: record.ttl,
                };
                this.addError = '';
            },
            cancelEdit() {
                this.editingRecord = null;
                this.newRecord = {hostname: '', domain: '', ip: '', record_type: 'A', ttl: 300};
                this.addError = '';
            },
            async updateRecord() {
                this.addError = '';
                if (!this.editingRecord.hostname || !this.editingRecord.ip) {
                    this.addError = 'Hostname and IP address are required.';
                    return;
                }
                try {
                    const r = await fetch(`/api/local-records/${this.editingRecord.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            hostname: this.editingRecord.hostname,
                            domain: (this.editingRecord.domain || '').trim() || null,
                            ip: this.editingRecord.ip,
                            record_type: this.editingRecord.record_type,
                            ttl: parseInt(this.editingRecord.ttl) || 300
                        })
                    });
                    if (r.ok) {
                        this.editingRecord = null;
                        await this.loadRecords();
                        this.$nextTick(() => scheduleLucide());
                    } else {
                        this.addError = await r.text() || 'Failed to update record';
                    }
                } catch (e) {
                    console.error(e);
                    this.addError = 'Network error: ' + e.message;
                }
            },
            async addRecord() {
                this.addError = '';
                if (!this.newRecord.hostname || !this.newRecord.ip) {
                    this.addError = 'Hostname and IP address are required.';
                    return;
                }
                try {
                    const r = await fetch('/api/local-records', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            hostname: this.newRecord.hostname,
                            domain: (this.newRecord.domain || '').trim() || null,
                            ip: this.newRecord.ip,
                            record_type: this.newRecord.record_type,
                            ttl: parseInt(this.newRecord.ttl) || 300
                        })
                    });
                    if (r.ok) {
                        await this.loadRecords();
                        this.newRecord = {hostname: '', domain: '', ip: '', record_type: 'A', ttl: 300};
                        this.$nextTick(() => scheduleLucide());
                    } else {
                        this.addError = await r.text() || 'Failed to add record';
                    }
                } catch (e) {
                    console.error(e);
                    this.addError = 'Network error: ' + e.message;
                }
            },
            async deleteRecord(id) {
                if (!confirm('Delete this DNS record?')) return;
                try {
                    const r = await fetch(`/api/local-records/${id}`, {method: 'DELETE'});
                    if (r.ok) {
                        await this.loadRecords();
                        this.$nextTick(() => scheduleLucide());
                    } else {
                        alert('Failed to delete record');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Network error: ' + e.message);
                }
            },
        }
    }
</script>
</body>
</html>
