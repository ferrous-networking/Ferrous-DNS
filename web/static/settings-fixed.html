<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ Settings - Ferrous DNS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; }
        .strategy-badge { @apply px-2 py-1 rounded text-xs font-semibold; }
        .strategy-parallel { @apply bg-purple-100 text-purple-800; }
        .strategy-balanced { @apply bg-blue-100 text-blue-800; }
        .strategy-failover { @apply bg-green-100 text-green-800; }
        .health-healthy { @apply text-green-600; }
        .health-unhealthy { @apply text-red-600; }
        .health-unknown { @apply text-gray-400; }
    </style>
</head>
<body class="bg-gray-50 h-full" x-data="settings()" x-init="init()">

<header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
            <div class="flex items-center space-x-3">
                <div class="text-3xl sm:text-4xl">âš™ï¸</div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Settings</h1>
                    <p class="text-xs sm:text-sm text-gray-500">Ferrous DNS Configuration</p>
                </div>
            </div>

            <nav class="flex flex-wrap gap-2 w-full sm:w-auto">
                <a href="/dashboard.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 text-center">
                    ğŸ“Š Dashboard
                </a>
                <a href="/queries.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 text-center">
                    ğŸ“‹ Query Log
                </a>
                <a href="/settings.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 text-center">
                    âš™ï¸ Settings
                </a>
            </nav>
        </div>
    </div>
</header>

<main class="w-full min-h-screen bg-gray-50 px-3 sm:px-4 lg:px-8 py-4 sm:py-6 lg:py-8">
    <!-- Alert Messages -->
    <div x-show="alert.show" x-cloak :class="alert.type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'" class="border px-3 sm:px-4 py-2 sm:py-3 rounded-lg mb-4 sm:mb-6 relative text-sm sm:text-base" role="alert">
        <strong class="font-bold text-sm sm:text-base" x-text="alert.type === 'success' ? 'âœ… Success!' : 'âŒ Error!'"></strong>
        <span class="block sm:inline text-sm sm:text-base" x-text="alert.message"></span>
        <button @click="alert.show = false" class="absolute top-0 bottom-0 right-0 px-3 sm:px-4 py-2 sm:py-3"><span class="text-xl sm:text-2xl">&times;</span></button>
    </div>

    <!-- Tabs -->
    <div class="mb-4 sm:mb-6 border-b border-gray-200 overflow-x-auto">
        <nav class="flex space-x-4 sm:space-x-8 min-w-max px-1" aria-label="Tabs">
            <button @click="currentTab = 'dns'" :class="currentTab === 'dns' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                ğŸŒ DNS & Load Balancing
            </button>
            <button @click="currentTab = 'cache'" :class="currentTab === 'cache' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                âš¡ Cache Settings
            </button>
            <button @click="currentTab = 'adblock'" :class="currentTab === 'adblock' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                ğŸš« Ad Blocking
            </button>
        </nav>
    </div>

    <!-- DNS & Load Balancing Tab -->
    <div x-show="currentTab === 'dns'" x-cloak>
        <!-- Strategy Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">âš¡</span>
                    <h3 class="font-bold text-purple-900">Parallel</h3>
                </div>
                <p class="text-sm text-purple-800 mb-2">Sends query to all upstreams, returns fastest response</p>
                <div class="text-xs text-purple-700">
                    <div class="flex justify-between mb-1"><span>Latency:</span><span class="font-semibold">âš¡ Best</span></div>
                    <div class="flex justify-between mb-1"><span>Network:</span><span class="font-semibold">ğŸ’¸ High</span></div>
                    <div class="flex justify-between"><span>Use when:</span><span class="font-semibold">Speed critical</span></div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">âš–ï¸</span>
                    <h3 class="font-bold text-blue-900">Balanced</h3>
                </div>
                <p class="text-sm text-blue-800 mb-2">Round-robin load distribution across upstreams</p>
                <div class="text-xs text-blue-700">
                    <div class="flex justify-between mb-1"><span>Latency:</span><span class="font-semibold">âš–ï¸ Medium</span></div>
                    <div class="flex justify-between mb-1"><span>Network:</span><span class="font-semibold">âœ… Low</span></div>
                    <div class="flex justify-between"><span>Use when:</span><span class="font-semibold">Even distribution</span></div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">ğŸ”</span>
                    <h3 class="font-bold text-green-900">Failover</h3>
                </div>
                <p class="text-sm text-green-800 mb-2">Sequential fallback until one succeeds</p>
                <div class="text-xs text-green-700">
                    <div class="flex justify-between mb-1"><span>Latency:</span><span class="font-semibold">ğŸŒ Variable</span></div>
                    <div class="flex justify-between mb-1"><span>Network:</span><span class="font-semibold">âœ… Low</span></div>
                    <div class="flex justify-between"><span>Use when:</span><span class="font-semibold">Backup needed</span></div>
                </div>
            </div>
        </div>

        <!-- Upstream Pools -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ğŸ¯ Upstream DNS Pools</h2>
                <button @click="addPool()" class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">
                    â• Add Pool
                </button>
            </div>

            <template x-for="(pool, poolIndex) in pools" :key="poolIndex">
                <div class="border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pool Name</label>
                                <input type="text" x-model="pool.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="google-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Strategy</label>
                                <select x-model="pool.strategy" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="parallel">âš¡ Parallel</option>
                                    <option value="balanced">âš–ï¸ Balanced</option>
                                    <option value="failover">ğŸ” Failover</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                <input type="number" x-model.number="pool.priority" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="1">
                                <p class="text-xs text-gray-500 mt-1">1 = Primary, 2 = Backup</p>
                            </div>
                        </div>
                        <button @click="pools.splice(poolIndex, 1)" class="ml-3 px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            ğŸ—‘ï¸
                        </button>
                    </div>

                    <!-- Servers in Pool -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Servers</label>
                        <template x-for="(server, serverIndex) in pool.servers" :key="serverIndex">
                            <div class="flex gap-2">
                                <input type="text" x-model="pool.servers[serverIndex]" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="8.8.8.8:53">
                                <div class="flex items-center px-3 py-2 bg-white border border-gray-300 rounded-lg">
                                    <span :class="getHealthClass(server)" class="text-xl" x-text="getHealthIcon(server)"></span>
                                </div>
                                <button @click="pool.servers.splice(serverIndex, 1)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </template>
                        <button @click="pool.servers.push('')" class="px-3 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600">
                            â• Add Server
                        </button>
                    </div>
                </div>
            </template>

            <div x-show="pools.length === 0" class="text-center py-8 text-gray-500">
                No pools configured. Click "Add Pool" to create one.
            </div>
        </div>

        <!-- Health Check Settings -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ©º Health Check Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center">
                    <input type="checkbox" x-model="healthCheck.enabled" id="health_enabled" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                    <label for="health_enabled" class="ml-2 text-sm text-gray-700">Enable Health Checking</label>
                </div>
                <div x-show="healthCheck.enabled">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Check Interval (seconds)</label>
                    <input type="number" x-model.number="healthCheck.interval_seconds" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div x-show="healthCheck.enabled">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (ms)</label>
                    <input type="number" x-model.number="healthCheck.timeout_ms" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div x-show="healthCheck.enabled">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Failure Threshold</label>
                    <input type="number" x-model.number="healthCheck.failure_threshold" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">Mark unhealthy after N failures</p>
                </div>
            </div>
        </div>

        <!-- General DNS Settings -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">âš™ï¸ General DNS Settings</h2>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" x-model="dnsSettings.dnssec_enabled" id="dnssec_enabled" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                    <label for="dnssec_enabled" class="ml-2 text-sm text-gray-700">Enable DNSSEC Validation âœ¨</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" x-model="dnsSettings.cache_enabled" id="cache_enabled" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                    <label for="cache_enabled" class="ml-2 text-sm text-gray-700">Enable DNS Cache</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Settings Tab -->
    <div x-show="currentTab === 'cache'" x-cloak>
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold mb-4">âš¡ Cache Settings</h2>
            <p class="text-gray-600">Cache configuration settings</p>
        </div>
    </div>

    <!-- Ad Blocking Tab -->
    <div x-show="currentTab === 'adblock'" x-cloak>
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold mb-4">ğŸš« Ad Blocking</h2>
            <p class="text-gray-600">Ad blocking configuration</p>
        </div>
    </div>

    <!-- Save Buttons -->
    <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 flex gap-3">
        <button @click="saveConfig()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
            ğŸ’¾ Save Configuration
        </button>
        <button @click="saveAndApply()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
            ğŸ’¾ğŸ”„ Save & Apply Now
        </button>
        <button @click="reloadConfig()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
            ğŸ”„ Reload from File
        </button>
    </div>
</main>

<script>
function settings() {
    return {
        currentTab: 'dns',
        pools: [],
        healthCheck: {
            enabled: true,
            interval_seconds: 30,
            timeout_ms: 2000,
            failure_threshold: 3,
            success_threshold: 2
        },
        dnsSettings: {
            dnssec_enabled: false,
            cache_enabled: true
        },
        healthStatus: {},
        alert: {
            show: false,
            type: 'success',
            message: ''
        },

        async init() {
            console.log('Initializing settings...');
            await this.loadConfig();
            await this.loadHealthStatus();
            setInterval(() => this.loadHealthStatus(), 10000);
        },

        async loadConfig() {
            try {
                console.log('Loading config from /api/config...');
                const response = await fetch('/api/config');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Config loaded:', data);
                    
                    // Ensure pools exist
                    if (data.dns && Array.isArray(data.dns.pools)) {
                        this.pools = data.dns.pools.map(pool => ({
                            name: pool.name || '',
                            strategy: pool.strategy || 'parallel',
                            priority: pool.priority || 1,
                            servers: Array.isArray(pool.servers) ? pool.servers : []
                        }));
                    } else {
                        // Fallback: convert upstream_servers to a pool
                        this.pools = [];
                        if (data.dns && Array.isArray(data.dns.upstream_servers) && data.dns.upstream_servers.length > 0) {
                            this.pools.push({
                                name: 'default',
                                strategy: 'parallel',
                                priority: 1,
                                servers: data.dns.upstream_servers
                            });
                        }
                    }
                    
                    // Load health check settings
                    if (data.dns && data.dns.health_check) {
                        this.healthCheck = {
                            enabled: data.dns.health_check.enabled !== false,
                            interval_seconds: data.dns.health_check.interval_seconds || 30,
                            timeout_ms: data.dns.health_check.timeout_ms || 2000,
                            failure_threshold: data.dns.health_check.failure_threshold || 3,
                            success_threshold: data.dns.health_check.success_threshold || 2
                        };
                    }
                    
                    // Load DNS settings
                    if (data.dns) {
                        this.dnsSettings = {
                            dnssec_enabled: data.dns.dnssec_enabled || false,
                            cache_enabled: data.dns.cache_enabled !== false
                        };
                    }
                    
                    console.log('Pools loaded:', this.pools);
                    console.log('Health check loaded:', this.healthCheck);
                } else {
                    console.error('Failed to load config:', response.status);
                    this.showAlert('error', 'Failed to load configuration');
                }
            } catch (error) {
                console.error('Error loading config:', error);
                this.showAlert('error', 'Failed to load configuration: ' + error.message);
            }
        },

        async loadHealthStatus() {
            try {
                const response = await fetch('/api/health/upstreams');
                if (response.ok) {
                    this.healthStatus = await response.json();
                    console.log('Health status updated:', this.healthStatus);
                }
            } catch (error) {
                console.error('Failed to load health status:', error);
            }
        },

        getHealthIcon(server) {
            const status = this.healthStatus[server] || 'Unknown';
            return status === 'Healthy' ? 'âœ…' : (status === 'Unhealthy' ? 'âŒ' : 'â“');
        },

        getHealthClass(server) {
            const status = this.healthStatus[server] || 'Unknown';
            return status === 'Healthy' ? 'health-healthy' : (status === 'Unhealthy' ? 'health-unhealthy' : 'health-unknown');
        },

        addPool() {
            this.pools.push({
                name: '',
                strategy: 'parallel',
                priority: 1,
                servers: ['']
            });
        },

        async saveConfig() {
            try {
                const configToSave = {
                    dns: {
                        pools: this.pools,
                        health_check: this.healthCheck,
                        dnssec_enabled: this.dnsSettings.dnssec_enabled,
                        cache_enabled: this.dnsSettings.cache_enabled
                    }
                };

                console.log('Saving config:', configToSave);
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configToSave)
                });

                if (response.ok) {
                    this.showAlert('success', 'Configuration saved successfully!');
                } else {
                    this.showAlert('error', 'Failed to save configuration');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                this.showAlert('error', 'Failed to save configuration: ' + error.message);
            }
        },

        async saveAndApply() {
            try {
                const configToSave = {
                    dns: {
                        pools: this.pools,
                        health_check: this.healthCheck,
                        dnssec_enabled: this.dnsSettings.dnssec_enabled,
                        cache_enabled: this.dnsSettings.cache_enabled
                    }
                };

                const response = await fetch('/api/config/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configToSave)
                });

                if (response.ok) {
                    this.showAlert('success', 'Configuration saved and applied! Cache cleared.');
                    await this.loadConfig();
                } else {
                    this.showAlert('error', 'Failed to apply configuration');
                }
            } catch (error) {
                console.error('Error applying config:', error);
                this.showAlert('error', 'Failed to apply configuration: ' + error.message);
            }
        },

        async reloadConfig() {
            try {
                const response = await fetch('/api/config/reload', {
                    method: 'POST'
                });

                if (response.ok) {
                    this.showAlert('success', 'Configuration reloaded from file!');
                    await this.loadConfig();
                } else {
                    this.showAlert('error', 'Failed to reload configuration');
                }
            } catch (error) {
                console.error('Error reloading config:', error);
                this.showAlert('error', 'Failed to reload configuration: ' + error.message);
            }
        },

        showAlert(type, message) {
            this.alert = { show: true, type, message };
            setTimeout(() => {
                this.alert.show = false;
            }, 5000);
        }
    }
}
</script>

</body>
</html>
