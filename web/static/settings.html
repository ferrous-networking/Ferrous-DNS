<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #3B82F6;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --bg-primary: #F9FAFB;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F4F6;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --border-color: #E5E7EB
        }

        .dark {
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-tertiary: #94A3B8;
            --border-color: #334155
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-left: 260px;
            margin: 0
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 24px 16px 16px
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            padding: 8px;
            background: var(--color-primary);
            color: white;
            border-radius: 8px
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-tertiary)
        }

        .status-box {
            margin: 0 16px 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s infinite
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 var(--color-success)
            }
            50% {
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2)
            }
        }

        .nav-section {
            margin-bottom: 24px
        }

        .nav-section-title {
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: all .2s
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary)
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--color-primary);
            font-weight: 600;
            border-left: 3px solid var(--color-primary)
        }

        .nav-icon {
            width: 18px;
            height: 18px
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 16px;
            border-top: 1px solid var(--border-color)
        }

        .theme-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-secondary)
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 20px
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all .2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-size: 14px
        }

        .btn-primary {
            background: var(--color-primary);
            color: white
        }

        .btn-primary:hover {
            background: #2563EB
        }

        .btn-success {
            background: var(--color-success);
            color: white
        }

        .btn-success:hover {
            background: #059669
        }

        .btn-gray {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color)
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all .2s;
            color: var(--text-secondary);
            font-size: 14px
        }

        .tab-btn.active {
            border-color: var(--color-primary);
            color: var(--color-primary)
        }

        .strategy-card {
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            transition: all .2s;
            cursor: pointer;
            background: var(--bg-secondary)
        }

        .strategy-card:hover {
            border-color: var(--color-primary)
        }

        .strategy-card.selected {
            border-color: var(--color-primary);
            background: rgba(59, 130, 246, 0.05)
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px
        }

        label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .alert-success {
            background: #ECFDF5;
            border: 1px solid #10B981;
            color: #065F46
        }

        .alert-error {
            background: #FEF2F2;
            border: 1px solid #EF4444;
            color: #991B1B
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--text-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background .3s
        }

        .toggle-switch.active {
            background: var(--color-success)
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform .3s
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px)
        }
    </style>
</head>
<body x-data="app()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span>
        </div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span></div>
        <div class="status-item"><i data-lucide="zap" style="width:14px;height:14px"></i><span
                x-text="stats.queries_total+' queries'">Running</span></div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item"><i data-lucide="file-text"
                                                        class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item"><i data-lucide="users"
                <a href="/groups.html" class="nav-item">
                    <i data-lucide="layers" class="nav-icon"></i>
                    <span>Groups</span>
                </a>
                                                        class="nav-icon"></i><span>Clients</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item"><i data-lucide="hard-drive" class="nav-icon"></i><span>Local DNS</span></a>
            <a href="/settings.html" class="nav-item active"><i data-lucide="settings" class="nav-icon"></i><span>Settings</span></a>
        </div>
    </nav>
    <div class="sidebar-footer">
        <button @click="toggleTheme()" class="theme-btn">
            <i data-lucide="sun" x-show="theme==='light'" style="width:16px;height:16px"></i>
            <i data-lucide="moon" x-show="theme==='dark'" style="width:16px;height:16px"></i>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main style="padding:32px;width:100%;min-height:100vh">
    <!-- Restart Warning Banner -->
    <div x-show="restartRequired" x-cloak
         style="background:#FEF3C7;border:1px solid #F59E0B;border-radius:8px;padding:12px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
        <i data-lucide="alert-triangle" style="width:20px;height:20px;color:#F59E0B;flex-shrink:0"></i>
        <p style="font-size:14px;color:#92400E;margin:0;font-weight:500">Server restart required for settings to take
            effect</p>
    </div>

    <!-- Alert -->
    <div x-show="alert.show" :class="alert.type==='success'?'alert-success':'alert-error'" class="alert" x-cloak>
        <strong x-text="alert.message"></strong>
        <button @click="alert.show=false" style="font-size:20px;font-weight:700">&times;</button>
    </div>

    <!-- Loading -->
    <div x-show="loading" x-cloak style="text-align:center;padding:40px">
        <div style="display:inline-block;width:40px;height:40px;border:4px solid var(--border-color);border-top-color:var(--color-primary);border-radius:50%;animation:spin 1s linear infinite"></div>
        <p style="margin-top:16px;color:var(--text-secondary)">Loading configuration...</p>
    </div>

    <!-- Tabs -->
    <div x-show="!loading" style="margin-bottom:24px;border-bottom:1px solid var(--border-color)">
        <div style="display:flex;gap:8px">
            <button @click="currentTab='dnsbasic';setTimeout(()=>lucide.createIcons(),50)"
                    :class="currentTab==='dnsbasic'?'tab-btn active':'tab-btn'">
                <i data-lucide="shield"
                   style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px"></i> DNS
                Settings
            </button>
            <button @click="currentTab='dnsadvanced';setTimeout(()=>lucide.createIcons(),50)"
                    :class="currentTab==='dnsadvanced'?'tab-btn active':'tab-btn'">
                <i data-lucide="globe"
                   style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px"></i> DNS
                Advanced
            </button>
            <button @click="currentTab='cache';setTimeout(()=>lucide.createIcons(),50)"
                    :class="currentTab==='cache'?'tab-btn active':'tab-btn'">
                <i data-lucide="zap"
                   style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px"></i> Cache
                Settings
            </button>
            <button @click="currentTab='adblock';setTimeout(()=>lucide.createIcons(),50)"
                    :class="currentTab==='adblock'?'tab-btn active':'tab-btn'">
                <i data-lucide="shield-off"
                   style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px"></i> Ad
                Blocking
            </button>
        </div>
    </div>

    <!-- DNS Settings Tab -->
    <div x-show="currentTab==='dnsbasic'&&!loading" x-cloak>
        <div class="card">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:8px">üõ°Ô∏è DNS Settings</h3>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Configure advanced DNS behavior</p>

            <!-- Never forward non-FQDN -->
            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="shield-off" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward non-FQDN queries</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Tells Ferrous DNS to never forward
                        queries for plain names, without dots or domain parts, to upstream nameservers. If the name is
                        not known from <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or DHCP then a "not found" answer is returned.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">If Conditional
                        Forwarding is enabled, unticking this box may cause a partial loop.</p>
                </div>
                <div @click="settings.never_forward_non_fqdn=!settings.never_forward_non_fqdn"
                     :class="settings.never_forward_non_fqdn?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <!-- Never forward reverse lookups -->
            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="lock" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward reverse lookups for private IP
                            ranges</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">All reverse lookups for private IP
                        ranges (i.e., <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">192.168.0.x/24</code>,
                        etc.) which are not found in <code
                                style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or the DHCP leases are answered with "no such domain" rather than being forwarded upstream.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0">The set of prefixes affected is
                        the list given in <a href="https://tools.ietf.org/html/rfc6303"
                                             style="color:var(--color-primary)" target="_blank">RFC6303</a>.</p>
                </div>
                <div @click="settings.never_forward_reverse_lookups=!settings.never_forward_reverse_lookups"
                     :class="settings.never_forward_reverse_lookups?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <!-- Use Conditional Forwarding -->
            <div style="padding:16px 0">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px">
                    <div style="flex:1;margin-right:24px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="git-branch" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Use Conditional Forwarding</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">If not configured as your DHCP
                            server, Ferrous DNS typically won't be able to determine the names of devices on your local
                            network. As a result, tables such as Top Clients will only show IP addresses.</p>
                        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 0">One solution is to
                            configure Ferrous DNS to forward these requests to your DHCP server (most likely your
                            router), but only for devices on your home network. To configure this we will need to know
                            the IP address of your DHCP server and which addresses belong to your local network.</p>
                    </div>
                    <div @click="toggleConditionalForwarding()"
                         :class="settings.conditional_forwarding_enabled?'active':''" class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <!-- Config fields -->
                <div x-show="settings.conditional_forwarding_enabled" x-cloak
                     style="border-top:1px solid var(--border-color);padding-top:16px">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:16px">
                        <div>
                            <label>Local network in CIDR notation</label>
                            <input type="text" x-model="settings.local_network_cidr" placeholder="192.168.0.0/24"
                                   style="font-family:monospace">
                            <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Example: 192.168.0.0/24
                                or 10.0.0.0/8</p>
                        </div>
                        <div>
                            <label>IP address of your DHCP server (router)</label>
                            <input type="text" x-model="settings.router_ip" placeholder="192.168.0.1"
                                   style="font-family:monospace">
                            <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Usually your router's
                                IP</p>
                        </div>
                    </div>
                    <div style="margin-bottom:16px">
                        <label>Local domain name (optional)</label>
                        <input type="text" x-model="settings.local_domain" placeholder="fritz.box"
                               style="max-width:400px;font-family:monospace">
                        <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Optional: Like <code
                                style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">fritz.box</code>
                            to ensure queries to devices ending in your local domain name won't leave your network</p>
                    </div>
                </div>
            </div>
        </div>

        <button @click="saveDnsSettings()" class="btn btn-success"><i data-lucide="save"
                                                                      style="width:16px;height:16px"></i> Save DNS
            Settings
        </button>
    </div>

    <!-- DNS Advanced Tab -->
    <div x-show="currentTab==='dnsadvanced'&&!loading" x-cloak>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">
            <div class="strategy-card" :class="getFirstPoolStrategy()==='parallel'?'selected':''"
                 @click="setFirstPoolStrategy('parallel')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="zap" style="width:28px;height:28px;color:#A855F7"></i>
                    <h3 style="font-weight:700;font-size:16px">Parallel</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Sends query to all upstreams,
                    returns fastest response</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#10B981">‚ö° Best</strong></span>
                    <span>Network: <strong style="color:#EF4444">üí∏ High</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='balanced'?'selected':''"
                 @click="setFirstPoolStrategy('balanced')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="scale" style="width:28px;height:28px;color:#3B82F6"></i>
                    <h3 style="font-weight:700;font-size:16px">Balanced</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Round-robin load distribution
                    across upstreams</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#F59E0B">‚öñÔ∏è Medium</strong></span>
                    <span>Network: <strong style="color:#F59E0B">üíµ Medium</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='failover'?'selected':''"
                 @click="setFirstPoolStrategy('failover')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="arrow-down" style="width:28px;height:28px;color:#10B981"></i>
                    <h3 style="font-weight:700;font-size:16px">Failover</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Primary server, switch on
                    failure</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong>üì∂ Depends</strong></span>
                    <span>Network: <strong style="color:#10B981">üí∞ Low</strong></span>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3 style="font-size:18px;font-weight:700">üéØ Upstream DNS Pools</h3>
                <button @click="addPool()" class="btn btn-primary"><i data-lucide="plus"
                                                                      style="width:16px;height:16px"></i> Add Pool
                </button>
            </div>
            <template x-for="(pool,idx) in config.dns.pools" :key="idx">
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-bottom:16px;background:var(--bg-tertiary)">
                    <div style="display:grid;grid-template-columns:2fr 2fr 1fr auto;gap:12px;margin-bottom:16px">
                        <div><label>Pool Name</label><input type="text" x-model="pool.name"
                                                            placeholder="google-primary"></div>
                        <div><label>Strategy</label><select x-model="pool.strategy">
                            <option value="parallel">‚ö° Parallel</option>
                            <option value="balanced">‚öñÔ∏è Balanced</option>
                            <option value="failover">üîÅ Failover</option>
                        </select></div>
                        <div><label>Priority</label><input type="number" x-model.number="pool.priority" min="1"
                                                           placeholder="1"></div>
                        <div style="display:flex;align-items:flex-end">
                            <button @click="removePool(idx)" class="btn btn-gray" style="padding:10px"><i
                                    data-lucide="trash-2" style="width:16px;height:16px"></i></button>
                        </div>
                    </div>
                    <div><label>Servers</label>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <template x-for="(srv,sidx) in pool.servers" :key="sidx">
                                <div style="display:flex;gap:8px">
                                    <input type="text" x-model="pool.servers[sidx]" placeholder="8.8.8.8:53"
                                           style="flex:1">
                                    <div style="padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;min-width:40px;text-align:center">
                                        <span x-text="getServerHealth(srv)==='Healthy'?'‚úÖ':getServerHealth(srv)==='Unhealthy'?'‚ùå':'‚ùì'"></span>
                                    </div>
                                    <button @click="pool.servers.splice(sidx,1)" class="btn btn-gray"
                                            style="padding:10px"><i data-lucide="trash-2"
                                                                    style="width:16px;height:16px"></i></button>
                                </div>
                            </template>
                            <button @click="pool.servers.push('')" class="btn btn-primary" style="width:fit-content"><i
                                    data-lucide="plus" style="width:16px;height:16px"></i> Add Server
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            <div x-show="config.dns.pools.length===0"
                 style="text-align:center;padding:40px;color:var(--text-secondary)">No pools configured. Click "Add
                Pool" to create one.
            </div>
        </div>

        <div class="card">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">ü©∫ Health Check Configuration</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                                  x-model="config.dns.health_check.enabled"
                                                                                                  style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable Health Checking</span></label>
                </div>
                <div x-show="config.dns.health_check.enabled"><label>Interval (seconds)</label><input type="number"
                                                                                                      x-model.number="config.dns.health_check.interval_seconds">
                </div>
                <div x-show="config.dns.health_check.enabled"><label>Timeout (ms)</label><input type="number"
                                                                                                x-model.number="config.dns.health_check.timeout_ms">
                </div>
                <div x-show="config.dns.health_check.enabled"><label>Failure Threshold</label><input type="number"
                                                                                                     x-model.number="config.dns.health_check.failure_threshold">
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">‚öôÔ∏è General DNS Settings</h3>
            <div style="display:flex;flex-direction:column;gap:12px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                             x-model="config.dns.dnssec_enabled"
                                                                                             style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable DNSSEC Validation ‚ú®</span></label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                             x-model="config.dns.cache_enabled"
                                                                                             style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable DNS Cache</span></label>
            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success"><i data-lucide="save" style="width:16px;height:16px"></i>
            Save Advanced Settings
        </button>
    </div>

    <!-- Cache Tab -->
    <div x-show="currentTab==='cache'&&!loading" x-cloak>
        <div class="card">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">‚ö° Cache Configuration</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px">
                <div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                                  x-model="config.dns.cache_enabled"
                                                                                                  style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable DNS Cache</span></label>
                </div>
                <div x-show="config.dns.cache_enabled"><label>Cache TTL (seconds)</label><input type="number"
                                                                                                x-model.number="config.dns.cache_ttl"
                                                                                                min="1"></div>
                <div x-show="config.dns.cache_enabled"><label>Max Cache Entries</label><input type="number"
                                                                                              x-model.number="config.dns.cache_max_entries"
                                                                                              min="100"></div>
            </div>
            <div x-show="config.dns.cache_enabled" style="border-top:1px solid var(--border-color);padding-top:20px">
                <h4 style="font-size:16px;font-weight:600;margin-bottom:16px">üîß Advanced Settings</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">
                    <div><label>Eviction Strategy</label><select x-model="config.dns.cache_eviction_strategy">
                        <option value="lru">LRU (Least Recently Used)</option>
                        <option value="lfu">LFU (Least Frequently Used)</option>
                        <option value="lfu-k">LFU-K (Adaptive)</option>
                        <option value="hit-rate">Hit Rate Based</option>
                    </select></div>
                    <div><label>Min Hit Rate</label><input type="number" x-model.number="config.dns.cache_min_hit_rate"
                                                           step="0.1" min="0" max="1"></div>
                    <div><label>Refresh Threshold</label><input type="number"
                                                                x-model.number="config.dns.cache_refresh_threshold"
                                                                step="0.1" min="0" max="1"></div>
                    <div><label>Compaction Interval (s)</label><input type="number"
                                                                      x-model.number="config.dns.cache_compaction_interval"
                                                                      min="60"></div>
                </div>
                <div style="display:flex;flex-direction:column;gap:12px;margin-top:16px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                                 x-model="config.dns.cache_optimistic_refresh"
                                                                                                 style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable Optimistic Refresh</span></label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox"
                                                                                                 x-model="config.dns.cache_adaptive_thresholds"
                                                                                                 style="width:20px;height:20px;accent-color:var(--color-primary)"><span>Enable Adaptive Thresholds</span></label>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h3 style="font-size:18px;font-weight:700">üìä Cache Statistics</h3>
                <button @click="loadCacheStats()" class="btn btn-primary"><i data-lucide="refresh-cw"
                                                                             style="width:16px;height:16px"></i> Refresh
                </button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">
                <div style="background:rgba(59,130,246,0.1);padding:20px;border-radius:8px;text-align:center">
                    <div style="font-size:32px;font-weight:700;color:#3B82F6"
                         x-text="cacheStats.total_entries||0"></div>
                    <div style="font-size:12px;color:#3B82F6;margin-top:4px">Total Entries</div>
                </div>
                <div style="background:rgba(16,185,129,0.1);padding:20px;border-radius:8px;text-align:center">
                    <div style="font-size:32px;font-weight:700;color:#10B981"
                         x-text="cacheStats.hit_rate?((cacheStats.hit_rate*100).toFixed(1)+'%'):'0%'"></div>
                    <div style="font-size:12px;color:#10B981;margin-top:4px">Hit Rate</div>
                </div>
                <div style="background:rgba(168,85,247,0.1);padding:20px;border-radius:8px;text-align:center">
                    <div style="font-size:32px;font-weight:700;color:#A855F7" x-text="cacheStats.total_hits||0"></div>
                    <div style="font-size:12px;color:#A855F7;margin-top:4px">Total Hits</div>
                </div>
                <div style="background:rgba(245,158,11,0.1);padding:20px;border-radius:8px;text-align:center">
                    <div style="font-size:32px;font-weight:700;color:#F59E0B" x-text="cacheStats.total_misses||0"></div>
                    <div style="font-size:12px;color:#F59E0B;margin-top:4px">Total Misses</div>
                </div>
            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success"><i data-lucide="save" style="width:16px;height:16px"></i>
            Save Cache Settings
        </button>
    </div>

    <!-- Ad Block Tab -->
    <div x-show="currentTab==='adblock'&&!loading" x-cloak>
        <div class="card">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">üö´ Ad Blocking</h3>
            <p style="color:var(--text-secondary)">Ad blocking configuration (coming soon)</p>
        </div>
    </div>
</main>

<script>
    function app() {
        return {
            theme: 'light',
            currentTab: 'dnsbasic',
            loading: true,
            stats: {queries_total: 0},
            config: {
                dns: {
                    pools: [],
                    health_check: {enabled: true, interval_seconds: 30, timeout_ms: 2000, failure_threshold: 3},
                    dnssec_enabled: false,
                    cache_enabled: true,
                    cache_ttl: 3600,
                    cache_max_entries: 10000,
                    cache_eviction_strategy: 'lfu',
                    cache_min_hit_rate: 0.3,
                    cache_refresh_threshold: 0.8,
                    cache_compaction_interval: 300,
                    cache_optimistic_refresh: true,
                    cache_adaptive_thresholds: true
                }
            },
            settings: {
                never_forward_non_fqdn: false,
                never_forward_reverse_lookups: false,
                conditional_forwarding_enabled: false,
                local_network_cidr: '',
                router_ip: '',
                local_domain: ''
            },
            cacheStats: {total_entries: 0, hit_rate: 0, total_hits: 0, total_misses: 0},
            healthStatus: {},
            restartRequired: false,
            alert: {show: false, type: 'success', message: ''},
            async init() {
                console.log('Settings init...');
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadConfig(), this.loadDnsSettings(), this.loadHealthStatus(), this.loadCacheStats(), this.loadStats()]);
                setTimeout(() => lucide.createIcons(), 100);
                setInterval(() => {
                    this.loadHealthStatus();
                    this.loadStats()
                }, 10000)
            },
            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                setTimeout(() => lucide.createIcons(), 50)
            },
            async loadStats() {
                try {
                    const r = await fetch('/api/stats');
                    if (r.ok) this.stats = await r.json()
                } catch (e) {
                    console.error(e)
                }
            },
            async loadConfig() {
                try {
                    this.loading = true;
                    const res = await fetch('/api/config');
                    if (res.ok) {
                        const data = await res.json();
                        console.log('Config loaded:', data);
                        this.config = {
                            ...this.config, ...data,
                            dns: {
                                ...this.config.dns, ...(data.dns || {}),
                                pools: data.dns?.pools || [],
                                health_check: {
                                    enabled: data.dns?.health_check?.enabled ?? true,
                                    interval_seconds: data.dns?.health_check?.interval_seconds ?? 30,
                                    timeout_ms: data.dns?.health_check?.timeout_ms ?? 2000,
                                    failure_threshold: data.dns?.health_check?.failure_threshold ?? 3
                                },
                                cache_ttl: data.dns?.cache_ttl ?? 3600,
                                cache_max_entries: data.dns?.cache_max_entries ?? 10000,
                                cache_eviction_strategy: data.dns?.cache_eviction_strategy ?? 'lfu',
                                cache_min_hit_rate: data.dns?.cache_min_hit_rate ?? 0.3,
                                cache_refresh_threshold: data.dns?.cache_refresh_threshold ?? 0.8,
                                cache_compaction_interval: data.dns?.cache_compaction_interval ?? 300,
                                cache_optimistic_refresh: data.dns?.cache_optimistic_refresh ?? true,
                                cache_adaptive_thresholds: data.dns?.cache_adaptive_thresholds ?? true
                            }
                        };
                        if (this.config.dns.pools.length === 0 && data.dns?.upstream_servers?.length > 0) {
                            this.config.dns.pools = [{
                                name: 'default',
                                strategy: 'parallel',
                                priority: 1,
                                servers: [...data.dns.upstream_servers]
                            }]
                        }
                    } else {
                        this.showAlert('error', 'Failed to load configuration')
                    }
                } catch (e) {
                    console.error('Load config error:', e);
                    this.showAlert('error', 'Failed to load: ' + e.message)
                } finally {
                    this.loading = false
                }
            },
            async loadDnsSettings() {
                try {
                    const r = await fetch('/api/settings');
                    if (r.ok) this.settings = await r.json()
                } catch (e) {
                    console.log('Using default DNS settings', e)
                }
            },
            async loadHealthStatus() {
                try {
                    const res = await fetch('/api/health/upstreams');
                    if (res.ok) this.healthStatus = await res.json()
                } catch (e) {
                    console.error('Load health error:', e)
                }
            },
            async loadCacheStats() {
                try {
                    const res = await fetch('/api/cache/stats');
                    if (res.ok) this.cacheStats = await res.json()
                } catch (e) {
                    console.error('Load cache stats error:', e)
                }
            },
            getServerHealth(s) {
                return this.healthStatus[s] || 'Unknown'
            },
            addPool() {
                this.config.dns.pools.push({name: '', strategy: 'parallel', priority: 1, servers: ['']});
                setTimeout(() => lucide.createIcons(), 50)
            },
            removePool(idx) {
                this.config.dns.pools.splice(idx, 1)
            },
            getFirstPoolStrategy() {
                return this.config.dns.pools[0]?.strategy || 'parallel'
            },
            setFirstPoolStrategy(s) {
                if (this.config.dns.pools.length > 0) {
                    this.config.dns.pools[0].strategy = s
                } else {
                    this.addPool();
                    this.config.dns.pools[0].strategy = s
                }
            },
            async saveConfig() {
                try {
                    const res = await fetch('/api/config', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.config)
                    });
                    if (res.ok) {
                        this.showAlert('success', 'Configuration saved successfully!')
                    } else {
                        const err = await res.text();
                        this.showAlert('error', 'Failed to save: ' + err)
                    }
                } catch (e) {
                    this.showAlert('error', 'Failed to save: ' + e.message)
                }
            },
            async saveDnsSettings() {
                try {
                    const r = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.settings)
                    });
                    if (r.ok) {
                        const data = await r.json();
                        this.showAlert('success', 'DNS settings saved!');
                        if (data.message.includes('restart')) {
                            this.restartRequired = true
                        }
                    } else {
                        const error = await r.json();
                        this.showAlert('error', 'Failed: ' + (error.message || 'Unknown error'))
                    }
                } catch (e) {
                    console.error(e);
                    this.showAlert('error', 'Error: ' + e.message)
                }
            },
            toggleConditionalForwarding() {
                this.settings.conditional_forwarding_enabled = !this.settings.conditional_forwarding_enabled;
                if (!this.settings.conditional_forwarding_enabled) {
                    this.settings.local_network_cidr = '';
                    this.settings.router_ip = '';
                    this.settings.local_domain = ''
                }
            },
            showAlert(type, msg) {
                this.alert = {show: true, type, message: msg};
                setTimeout(() => {
                    this.alert.show = false
                }, 5000)
            }
        }
    }
</script>
<style>@keyframes spin {
           to {
               transform: rotate(360deg)
           }
       }

[x-cloak] {
    display: none !important
}</style>
</body>
</html>
