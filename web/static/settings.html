<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Settings - Ferrous DNS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 h-full" x-data="settings()" x-init="init()">

<header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
            <div class="flex items-center space-x-3">
                <div class="text-3xl sm:text-4xl">‚öôÔ∏è</div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Settings</h1>
                    <p class="text-xs sm:text-sm text-gray-500">Ferrous DNS Configuration</p>
                </div>
            </div>

            <nav class="flex flex-wrap gap-2 w-full sm:w-auto">
                <a href="/dashboard.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 text-center">
                    üìä Dashboard
                </a>
                <a href="/queries.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 text-center">
                    üìã Query Log
                </a>
                <a href="/settings.html" 
                   class="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 text-center">
                    ‚öôÔ∏è Settings
                </a>
            </nav>
        </div>
    </div>
</header>

<main class="w-full min-h-screen bg-gray-50 px-3 sm:px-4 lg:px-8 py-4 sm:py-6 lg:py-8">
    <!-- Alert Messages -->
    <div x-show="alert.show" x-cloak :class="alert.type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'" class="border px-3 sm:px-4 py-2 sm:py-3 rounded-lg mb-4 sm:mb-6 relative text-sm sm:text-base" role="alert">
        <strong class="font-bold text-sm sm:text-base" x-text="alert.type === 'success' ? '‚úÖ Success!' : '‚ùå Error!'"></strong>
        <span class="block sm:inline text-sm sm:text-base" x-text="alert.message"></span>
        <button @click="alert.show = false" class="absolute top-0 bottom-0 right-0 px-3 sm:px-4 py-2 sm:py-3"><span class="text-xl sm:text-2xl">&times;</span></button>
    </div>

    <!-- Permission Warning -->
    <div x-show="!config.writable && config.config_path" x-cloak class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-3 sm:px-4 py-2 sm:py-3 rounded-lg mb-4 sm:mb-6 text-sm sm:text-base">
        <strong class="font-bold">‚ö†Ô∏è Warning:</strong> <span>Config file is read-only. You cannot save changes.</span>
        <p class="text-xs sm:text-sm mt-1">File: <code class="bg-yellow-200 px-1 rounded text-xs sm:text-sm break-all" x-text="config.config_path"></code></p>
    </div>

    <!-- Tabs -->
    <div class="mb-4 sm:mb-6 border-b border-gray-200 overflow-x-auto">
        <nav class="flex space-x-4 sm:space-x-8 min-w-max px-1" aria-label="Tabs">
            <button @click="currentTab = 'dns'" :class="currentTab === 'dns' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                üåê DNS Settings
            </button>
            <button @click="currentTab = 'cache'" :class="currentTab === 'cache' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                ‚ö° Cache Settings
            </button>
            <button @click="currentTab = 'adblock'" :class="currentTab === 'adblock' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-xs sm:text-sm">
                üö´ Ad Blocking
            </button>
        </nav>
    </div>

    <!-- DNS Settings Tab -->
    <div x-show="currentTab === 'dns'" x-cloak>
        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
            <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">üåê DNS Settings</h2>
            <div class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Upstream DNS Servers</label>
                    <template x-for="(server, index) in config.dns.upstream_servers" :key="index">
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="config.dns.upstream_servers[index]" class="flex-1 px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="8.8.8.8:53">
                            <button @click="config.dns.upstream_servers.splice(index, 1)" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                        </div>
                    </template>
                    <button @click="config.dns.upstream_servers.push('')" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">‚ûï Add Server</button>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" x-model="config.dns.dnssec_enabled" id="dnssec_enabled" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="dnssec_enabled" class="ml-2 text-sm text-gray-700">Enable DNSSEC Validation ‚ú® <span class="text-xs text-gray-500">(Cryptographic validation of DNS responses)</span></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Settings Tab -->
    <div x-show="currentTab === 'cache'" x-cloak>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- LEFT COLUMN: Configuration -->
            <div class="lg:col-span-2 space-y-4 sm:space-y-6">
                
                <!-- Basic Cache Settings -->
                <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex items-center">
                        <span class="mr-2">‚ö°</span> Cache Configuration
                    </h2>
                    
                    <div class="space-y-3 sm:space-y-4">
                        <!-- Cache Enabled -->
                        <div class="flex items-center justify-between p-3 sm:p-4 bg-gray-50 rounded-lg">
                            <div class="flex-1 mr-4">
                                <div class="font-medium text-gray-900 text-sm sm:text-base">Enable DNS Cache</div>
                                <div class="text-xs sm:text-sm text-gray-600">Cache DNS responses to improve performance</div>
                            </div>
                            <input type="checkbox" x-model="config.dns.cache_enabled" class="w-10 h-6 sm:w-12 sm:h-6 rounded-full relative inline-flex items-center cursor-pointer">
                        </div>

                        <!-- Max Entries -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Max Cache Entries
                                <span class="text-gray-500 font-normal">(Currently: <span x-text="cacheMetrics.total_entries || 0"></span> entries)</span>
                            </label>
                            <input type="number" x-model.number="config.dns.cache_max_entries" min="1000" max="1000000" step="1000"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Recommended: 10,000-50,000 entries</p>
                        </div>

                        <!-- Default TTL -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Default TTL (seconds)
                                <span class="text-gray-500 font-normal">- Cache lifetime</span>
                            </label>
                            <input type="number" x-model.number="config.dns.cache_ttl" min="60" max="86400"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Default: 3600 (1 hour)</p>
                        </div>
                    </div>
                </div>

                <!-- Eviction Strategy -->
                <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">üéØ Eviction Strategy</h3>
                    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">Choose how to remove entries when cache is full</p>
                    
                    <div class="space-y-2 sm:space-y-3">
                        <label class="flex items-start p-3 sm:p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition" 
                               :class="config.dns.cache_eviction_strategy === 'hit_rate' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="radio" x-model="config.dns.cache_eviction_strategy" value="hit_rate" class="mt-1">
                            <div class="ml-2 sm:ml-3 flex-1">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-0">
                                    <span class="font-medium text-gray-900 text-sm sm:text-base">Hit Rate</span>
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded w-fit">Recommended</span>
                                </div>
                                <p class="text-xs sm:text-sm text-gray-600 mt-1">Removes entries with lowest hits/second. Best for changing traffic patterns.</p>
                            </div>
                        </label>

                        <label class="flex items-start p-3 sm:p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                               :class="config.dns.cache_eviction_strategy === 'lfu' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="radio" x-model="config.dns.cache_eviction_strategy" value="lfu" class="mt-1">
                            <div class="ml-2 sm:ml-3 flex-1">
                                <span class="font-medium text-gray-900 text-sm sm:text-base">LFU (Least Frequently Used)</span>
                                <p class="text-xs sm:text-sm text-gray-600 mt-1">Removes entries with lowest total hits. Best for stable usage patterns.</p>
                            </div>
                        </label>

                        <label class="flex items-start p-3 sm:p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                               :class="config.dns.cache_eviction_strategy === 'lfu-k' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="radio" x-model="config.dns.cache_eviction_strategy" value="lfu-k" class="mt-1">
                            <div class="ml-2 sm:ml-3 flex-1">
                                <span class="font-medium text-gray-900 text-sm sm:text-base">LFU-K (Balanced)</span>
                                <p class="text-xs sm:text-sm text-gray-600 mt-1">Uses sliding window for frequency tracking. Best hybrid approach.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Advanced Features -->
                <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">üöÄ Advanced Features</h3>
                    
                    <div class="space-y-3 sm:space-y-4">
                        <!-- Optimistic Refresh -->
                        <div class="p-3 sm:p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
                            <div class="flex items-start">
                                <input type="checkbox" x-model="config.dns.cache_optimistic_refresh" id="opt_refresh" 
                                       class="mt-1 w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <div class="ml-2 sm:ml-3 flex-1">
                                    <label for="opt_refresh" class="font-medium text-gray-900 cursor-pointer text-sm sm:text-base flex flex-wrap items-center gap-1 sm:gap-2">
                                        ‚ö° Optimistic Refresh
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Popular</span>
                                    </label>
                                    <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                        Proactively updates popular cache entries before they expire. 
                                        <strong>Eliminates cache misses for frequently accessed domains!</strong>
                                    </p>
                                    <div class="mt-2 text-xs text-gray-500 space-y-1">
                                        <div>‚úÖ Refreshes at <span x-text="(config.dns.cache_refresh_threshold * 100) + '%'"></span> of TTL</div>
                                        <div>‚úÖ Currently refreshing <span x-text="cacheMetrics.total_refreshes || 0"></span> entries</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lazy Expiration -->
                        <div class="p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-start">
                                <input type="checkbox" x-model="config.dns.cache_lazy_expiration" id="lazy_exp"
                                       class="mt-1 w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <div class="ml-2 sm:ml-3 flex-1">
                                    <label for="lazy_exp" class="font-medium text-gray-900 cursor-pointer text-sm sm:text-base">
                                        üí§ Lazy Expiration
                                    </label>
                                    <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                        Check if entries are expired only when accessed. Reduces background CPU usage.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Adaptive Thresholds -->
                        <div class="p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-start">
                                <input type="checkbox" x-model="config.dns.cache_adaptive_thresholds" id="adapt_thresh"
                                       class="mt-1 w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <div class="ml-2 sm:ml-3 flex-1">
                                    <label for="adapt_thresh" class="font-medium text-gray-900 cursor-pointer text-sm sm:text-base">
                                        üéØ Adaptive Thresholds
                                    </label>
                                    <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                        Automatically adjust eviction thresholds based on cache effectiveness.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Compaction Interval -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                üßπ Background Compaction Interval (seconds)
                            </label>
                            <input type="number" x-model.number="config.dns.cache_compaction_interval" min="60" max="3600"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">How often to clean up marked entries. Default: 300 (5 min)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Live Statistics -->
            <div class="lg:col-span-1">
                <div class="lg:sticky lg:top-24 space-y-3 sm:space-y-4">
                    <!-- Status Card -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 text-white">
                        <div class="flex items-center justify-between mb-3 sm:mb-4">
                            <h3 class="text-base sm:text-lg font-bold">Cache Status</h3>
                            <button @click="loadCacheMetrics()" class="p-1.5 sm:p-2 bg-white/20 hover:bg-white/30 rounded-lg transition text-sm sm:text-base">
                                üîÑ
                            </button>
                        </div>
                        
                        <div class="space-y-2 sm:space-y-3">
                            <div>
                                <div class="text-xs sm:text-sm opacity-90">Cache Enabled</div>
                                <div class="text-xl sm:text-2xl font-bold" x-text="config.dns.cache_enabled ? '‚úÖ Active' : '‚ùå Disabled'"></div>
                            </div>
                            <div class="border-t border-white/20 pt-2 sm:pt-3">
                                <div class="text-xs sm:text-sm opacity-90">Hit Rate</div>
                                <div class="text-2xl sm:text-3xl font-bold" x-text="(cacheMetrics.hit_rate || 0).toFixed(1) + '%'"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-2 sm:gap-3">
                        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4">
                            <div class="text-xs text-gray-500 mb-1">Cache Hits</div>
                            <div class="text-xl sm:text-2xl font-bold text-purple-600" x-text="cacheMetrics.total_hits || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4">
                            <div class="text-xs text-gray-500 mb-1">Cache Misses</div>
                            <div class="text-xl sm:text-2xl font-bold text-blue-600" x-text="cacheMetrics.total_misses || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4">
                            <div class="text-xs text-gray-500 mb-1">Refreshes</div>
                            <div class="text-xl sm:text-2xl font-bold text-yellow-600" x-text="cacheMetrics.total_refreshes || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4">
                            <div class="text-xs text-gray-500 mb-1">Entries</div>
                            <div class="text-xl sm:text-2xl font-bold text-green-600" x-text="cacheMetrics.total_entries || 0"></div>
                        </div>
                    </div>

                    <!-- Advanced Metrics -->
                    <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-3 sm:p-4">
                        <h4 class="font-semibold text-xs sm:text-sm text-gray-700 mb-2 sm:mb-3">üìä Detailed Metrics</h4>
                        <div class="space-y-1.5 sm:space-y-2 text-xs sm:text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Insertions:</span>
                                <span class="font-medium" x-text="cacheMetrics.insertions || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Evictions:</span>
                                <span class="font-medium" x-text="cacheMetrics.evictions || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Compactions:</span>
                                <span class="font-medium" x-text="cacheMetrics.compactions || 0"></span>
                            </div>
                            <div class="flex justify-between border-t pt-1.5 sm:pt-2">
                                <span class="text-gray-600">Refresh Rate:</span>
                                <span class="font-medium text-green-600" x-text="(cacheMetrics.refresh_rate || 0).toFixed(1) + '%'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Info Card -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                        <div class="flex items-start">
                            <span class="text-xl sm:text-2xl mr-2">üí°</span>
                            <div class="text-xs text-blue-800">
                                <strong>Tip:</strong> Enable Optimistic Refresh for best performance. 
                                It eliminates cache misses for popular domains by refreshing them before expiration.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ad Blocking Tab -->
    <div x-show="currentTab === 'adblock'" x-cloak>
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">üö´ Ad Blocking</h2>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" x-model="config.blocking.enabled" id="blocking_enabled" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="blocking_enabled" class="ml-2 text-sm text-gray-700 font-medium">Enable Ad/Tracker Blocking</label>
                </div>
                
                <div x-show="config.blocking.enabled">
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Blocked Domains</label>
                        <template x-for="(domain, index) in config.blocking.custom_blocked" :key="index">
                            <div class="flex gap-2 mb-2">
                                <input type="text" x-model="config.blocking.custom_blocked[index]" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ads.example.com">
                                <button @click="config.blocking.custom_blocked.splice(index, 1)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                            </div>
                        </template>
                        <button @click="config.blocking.custom_blocked.push('')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">‚ûï Add Domain</button>
                    </div>
                    
                    <div class="border-t pt-4 mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Whitelist (Never Block)</label>
                        <template x-for="(domain, index) in config.blocking.whitelist" :key="index">
                            <div class="flex gap-2 mb-2">
                                <input type="text" x-model="config.blocking.whitelist[index]" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="analytics.google.com">
                                <button @click="config.blocking.whitelist.splice(index, 1)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                            </div>
                        </template>
                        <button @click="config.blocking.whitelist.push('')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">‚ûï Add Domain</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Buttons (always visible) -->
    <div class="flex flex-wrap gap-4">
        <button @click="saveConfig()" :disabled="saving || !config.writable" :class="saving || !config.writable ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'" class="px-6 py-3 text-white rounded-lg font-bold">
            <span x-show="!saving">üíæ Save Configuration</span>
            <span x-show="saving">‚è≥ Saving...</span>
        </button>
        
        <button @click="saveAndReload()" :disabled="saving || !config.writable" :class="saving || !config.writable ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'" class="px-6 py-3 text-white rounded-lg font-bold">
            <span x-show="!saving">üíæüîÑ Save & Apply Now</span>
            <span x-show="saving">‚è≥ Applying...</span>
        </button>
        
        <button @click="loadConfig()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700">üîÑ Reload from File</button>
    </div>

    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-sm text-blue-800">
            <strong>‚ÑπÔ∏è Note:</strong> Use <strong>"Save & Apply Now"</strong> to reload configuration and clear cache immediately without restarting the server. 
            Changes take effect instantly!
        </p>
    </div>
</main>

<script>
function settings() {
    return {
        currentTab: 'dns',
        config: { 
            dns: { 
                upstream_servers: [], 
                cache_enabled: true, 
                cache_eviction_strategy: 'hit_rate',
                cache_optimistic_refresh: true,
                cache_adaptive_thresholds: false,
                dnssec_enabled: false 
            }, 
            blocking: { 
                enabled: true, 
                custom_blocked: [], 
                whitelist: [] 
            }, 
            config_path: null, 
            writable: false 
        },
        alert: { show: false, type: 'success', message: '' },
        saving: false,
        cacheMetrics: {
            total_entries: 0,
            total_hits: 0,
            total_misses: 0,
            total_refreshes: 0,
            hit_rate: 0,
            refresh_rate: 0,
            insertions: 0,
            evictions: 0,
            compactions: 0
        },
        
        async init() { 
            await this.loadConfig();
            await this.loadCacheMetrics();
            
            // Auto-refresh cache metrics every 5 seconds when on cache tab
            setInterval(() => {
                if (this.currentTab === 'cache') {
                    this.loadCacheMetrics();
                }
            }, 5000);
        },
        
        async loadConfig() {
            try {
                const res = await fetch('/api/config');
                this.config = await res.json();
            } catch (error) {
                console.error('Error loading config:', error);
                this.showAlert('error', 'Failed to load configuration');
            }
        },
        
        async saveConfig() {
            if (!this.config.writable) { 
                this.showAlert('error', 'Config file is read-only. Cannot save changes.'); 
                return; 
            }
            
            this.saving = true;
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dns: { 
                            upstream_servers: this.config.dns.upstream_servers.filter(s => s.trim()), 
                            cache_enabled: this.config.dns.cache_enabled, 
                            dnssec_enabled: this.config.dns.dnssec_enabled,
                            cache_eviction_strategy: this.config.dns.cache_eviction_strategy,
                            cache_optimistic_refresh: this.config.dns.cache_optimistic_refresh,
                            cache_adaptive_thresholds: this.config.dns.cache_adaptive_thresholds
                        },
                        blocking: { 
                            enabled: this.config.blocking.enabled, 
                            custom_blocked: this.config.blocking.custom_blocked.filter(d => d.trim()), 
                            whitelist: this.config.blocking.whitelist.filter(d => d.trim()) 
                        }
                    })
                });
                
                const data = await res.json();
                if (data.success) { 
                    this.showAlert('success', data.message); 
                    await this.loadConfig(); 
                } else { 
                    this.showAlert('error', data.error); 
                }
            } catch (error) {
                console.error('Error saving config:', error);
                this.showAlert('error', 'Failed to save configuration');
            } finally {
                this.saving = false;
            }
        },
        
        async saveAndReload() {
            if (!this.config.writable) { 
                this.showAlert('error', 'Config file is read-only. Cannot save changes.'); 
                return; 
            }
            
            this.saving = true;
            try {
                // First save the config
                const saveRes = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dns: { 
                            upstream_servers: this.config.dns.upstream_servers.filter(s => s.trim()), 
                            cache_enabled: this.config.dns.cache_enabled, 
                            dnssec_enabled: this.config.dns.dnssec_enabled,
                            cache_eviction_strategy: this.config.dns.cache_eviction_strategy,
                            cache_optimistic_refresh: this.config.dns.cache_optimistic_refresh,
                            cache_adaptive_thresholds: this.config.dns.cache_adaptive_thresholds
                        },
                        blocking: { 
                            enabled: this.config.blocking.enabled, 
                            custom_blocked: this.config.blocking.custom_blocked.filter(d => d.trim()), 
                            whitelist: this.config.blocking.whitelist.filter(d => d.trim()) 
                        }
                    })
                });
                
                const saveData = await saveRes.json();
                if (!saveData.success) {
                    this.showAlert('error', saveData.error);
                    return;
                }
                
                // Then reload config and clear cache
                const reloadRes = await fetch('/api/config/reload', {
                    method: 'POST'
                });
                
                const reloadData = await reloadRes.json();
                if (reloadData.success) {
                    this.showAlert('success', reloadData.message + ' ‚úÖ Applied immediately!');
                    await this.loadConfig();
                    await this.loadCacheMetrics(); // Refresh cache metrics
                } else {
                    this.showAlert('error', reloadData.error);
                }
            } catch (error) {
                console.error('Error saving and reloading config:', error);
                this.showAlert('error', 'Failed to save and reload configuration');
            } finally {
                this.saving = false;
            }
        },
        
        async loadCacheMetrics() {
            try {
                console.log('Fetching cache metrics...');
                const res = await fetch('/api/cache/metrics');
                if (!res.ok) {
                    console.error('Cache metrics API error:', res.status);
                    return;
                }
                const metrics = await res.json();
                
                this.cacheMetrics = {
                    total_hits: metrics.hits,
                    total_misses: metrics.misses,
                    total_refreshes: metrics.optimistic_refreshes,
                    total_entries: metrics.total_entries,
                    hit_rate: metrics.hit_rate,
                    refresh_rate: metrics.hits > 0 
                        ? (metrics.optimistic_refreshes / metrics.hits * 100) 
                        : 0,
                    insertions: metrics.insertions,
                    evictions: metrics.evictions,
                    compactions: metrics.compactions
                };
                
                console.log('Cache metrics loaded:', this.cacheMetrics);
            } catch (error) {
                console.error('Error loading cache metrics:', error);
            }
        },
        
        showAlert(type, message) { 
            this.alert = { show: true, type, message }; 
            setTimeout(() => { this.alert.show = false; }, 5000); 
        }
    }
}
</script>
</body>
</html>
