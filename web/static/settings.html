<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif
        }

        .card {
            padding: 24px;
            margin-bottom: 24px
        }

        .card-stat {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all .2s
        }

        .card-stat:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px)
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 8px
        }

        .btn-primary { background: var(--color-primary); color: white }
        .btn-primary:hover { background: #2563EB }
        .btn-success { background: var(--color-success); color: white }
        .btn-success:hover { background: #059669 }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary) }
        .btn-secondary:hover { background: var(--border-color) }

        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s
        }

        .btn-icon:hover { background: var(--bg-tertiary); color: var(--text-primary) }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px
        }

        .tab-btn {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all .15s
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary)
        }

        .tab-btn:hover { color: var(--text-primary) }

        .strategy-card {
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            transition: all .2s;
            cursor: pointer;
            background: var(--bg-secondary)
        }

        .strategy-card:hover { border-color: var(--color-primary) }

        .strategy-card.selected {
            border-color: var(--color-primary);
            background: rgba(59, 130, 246, 0.05)
        }

        .input, select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box
        }

        .input:focus, select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--color-primary)
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary)
        }

        .form-group { margin-bottom: 16px }

        label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .alert-success {
            background: #ECFDF5;
            border: 1px solid #10B981;
            color: #065F46
        }

        .alert-error {
            background: #FEF2F2;
            border: 1px solid #EF4444;
            color: #991B1B
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--text-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background .3s;
            flex-shrink: 0
        }

        .toggle-switch.active { background: var(--color-success) }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform .3s
        }

        .toggle-switch.active .toggle-slider { transform: translateX(24px) }

        @keyframes spin {
            to { transform: rotate(360deg) }
        }
    </style>
</head>
<body x-data="app()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span></div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span>
        </div>
        <div class="status-item">
            <i data-lucide="zap" style="width:14px;height:14px"></i>
            <span x-text="stats.queries_total+' queries'">Running</span>
        </div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item"><i data-lucide="file-text" class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
            <a href="/block-services.html" class="nav-item">
                <i data-lucide="shield-ban" class="nav-icon"></i>
                <span>Block Services</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item"><i data-lucide="hard-drive" class="nav-icon"></i><span>Local DNS</span></a>
            <a href="/settings.html" class="nav-item active"><i data-lucide="settings" class="nav-icon"></i><span>Settings</span></a>
        </div>
    </nav>
</aside>

<main style="padding:24px">

    <div style="margin-bottom:24px">
        <h1 style="font-size:28px;font-weight:700;margin-bottom:4px;color:var(--text-primary)">Settings</h1>
        <p style="font-size:14px;color:var(--text-secondary)">Configure DNS server behavior, upstream pools, and cache settings</p>
    </div>

    <div x-show="restartRequired" x-cloak
         style="background:#FEF3C7;border:1px solid #F59E0B;border-radius:8px;padding:12px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
        <i data-lucide="alert-triangle" style="width:20px;height:20px;color:#F59E0B;flex-shrink:0"></i>
        <p style="font-size:14px;color:#92400E;margin:0;font-weight:500">Server restart required for settings to take effect</p>
    </div>

    <div x-show="alert.show" :class="alert.type==='success'?'alert-success':'alert-error'" class="alert" x-cloak>
        <strong x-text="alert.message"></strong>
        <button @click="alert.show=false" style="font-size:20px;font-weight:700;background:none;border:none;cursor:pointer">&times;</button>
    </div>

    <div x-show="loading" x-cloak style="text-align:center;padding:40px">
        <div style="display:inline-block;width:40px;height:40px;border:4px solid var(--border-color);border-top-color:var(--color-primary);border-radius:50%;animation:spin 1s linear infinite"></div>
        <p style="margin-top:16px;color:var(--text-secondary)">Loading configuration...</p>
    </div>

    <div x-show="!loading" class="tab-bar">
        <button @click="currentTab='dnsbasic';scheduleLucide()"
                :class="currentTab==='dnsbasic'?'tab-btn active':'tab-btn'">DNS Settings</button>
        <button @click="currentTab='dnsadvanced';scheduleLucide()"
                :class="currentTab==='dnsadvanced'?'tab-btn active':'tab-btn'">DNS Advanced</button>
        <button @click="currentTab='cache';scheduleLucide()"
                :class="currentTab==='cache'?'tab-btn active':'tab-btn'">Cache Settings</button>
        <button @click="currentTab='webinterface';scheduleLucide()"
                :class="currentTab==='webinterface'?'tab-btn active':'tab-btn'">Web Interface</button>
    </div>

    <!-- DNS SETTINGS TAB -->
    <div x-show="currentTab==='dnsbasic'&&!loading" x-cloak>
        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">DNS Settings</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Configure advanced DNS behavior</p>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="shield-off" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward non-FQDN queries</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Tells Ferrous DNS to never forward
                        queries for plain names, without dots or domain parts, to upstream nameservers. If the name is
                        not known from <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or DHCP then a "not found" answer is returned.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">If Conditional
                        Forwarding is enabled, unticking this box may cause a partial loop.</p>
                </div>
                <div @click="settings.never_forward_non_fqdn=!settings.never_forward_non_fqdn"
                     :class="settings.never_forward_non_fqdn?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="lock" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward reverse lookups for private IP ranges</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">All reverse lookups for private IP
                        ranges (i.e., <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">192.168.0.x/24</code>,
                        etc.) which are not found in <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or the DHCP leases are answered with "no such domain" rather than being forwarded upstream.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0">The set of prefixes affected is
                        the list given in <a href="https://tools.ietf.org/html/rfc6303" style="color:var(--color-primary)" target="_blank">RFC6303</a>.</p>
                </div>
                <div @click="settings.never_forward_reverse_lookups=!settings.never_forward_reverse_lookups"
                     :class="settings.never_forward_reverse_lookups?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div style="padding:16px 0">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px">
                    <div style="flex:1;margin-right:24px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="shield-check" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Block local domain from internet</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">When a local domain (e.g. <code style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">lan</code>) is configured, queries for that domain that are not found in local records will return NXDOMAIN instead of leaking to your upstream DNS servers.</p>
                        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 0">Set your router address as the local DNS server to also resolve hostnames for discovered clients.</p>
                    </div>
                    <div @click="toggleLocalDomain()"
                         :class="settings.local_domain?'active':''" class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div x-show="settings.local_domain" x-cloak
                     style="border-top:1px solid var(--border-color);padding-top:16px">
                    <div class="form-group" style="margin-bottom:16px">
                        <label class="form-label">Local domain name</label>
                        <input type="text" x-model="settings.local_domain" placeholder="lan"
                               style="max-width:400px;font-family:monospace">
                        <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Queries for <code style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">*.lan</code> not in local records will return NXDOMAIN</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Local DNS server <span style="color:var(--text-tertiary);font-weight:400">(optional)</span></label>
                        <input type="text" x-model="settings.local_dns_server" placeholder="192.168.1.1:53"
                               style="max-width:400px;font-family:monospace">
                        <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Your router or DHCP server. Used to resolve hostnames of discovered clients (e.g. <code style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">device.lan</code>)</p>
                    </div>
                </div>
            </div>
        </div>

        <button @click="saveDnsSettings()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save DNS Settings
        </button>
    </div>

    <!-- DNS ADVANCED TAB -->
    <div x-show="currentTab==='dnsadvanced'&&!loading" x-cloak>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">
            <div class="strategy-card" :class="getFirstPoolStrategy()==='parallel'?'selected':''"
                 @click="setFirstPoolStrategy('parallel')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="zap" style="width:28px;height:28px;color:#A855F7"></i>
                    <h3 style="font-weight:700;font-size:16px">Parallel</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Sends the query to all upstream servers simultaneously and returns the fastest response. Best latency at the cost of higher network usage.</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#10B981">Best</strong></span>
                    <span>Network: <strong style="color:#EF4444">High</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='balanced'?'selected':''"
                 @click="setFirstPoolStrategy('balanced')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="scale" style="width:28px;height:28px;color:#3B82F6"></i>
                    <h3 style="font-weight:700;font-size:16px">Balanced</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Distributes queries across upstream servers in round-robin order, spreading load evenly across all configured servers.</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#F59E0B">Medium</strong></span>
                    <span>Network: <strong style="color:#F59E0B">Medium</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='failover'?'selected':''"
                 @click="setFirstPoolStrategy('failover')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="shield-alert" style="width:28px;height:28px;color:#10B981"></i>
                    <h3 style="font-weight:700;font-size:16px">Failover</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Queries always go to the primary server. Automatically switches to the next server only when the primary becomes unreachable.</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong>Depends</strong></span>
                    <span>Network: <strong style="color:#10B981">Low</strong></span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">General Settings</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Core DNS resolution behavior settings.</p>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="shield-check" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">DNSSEC Validation</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Validates DNSSEC cryptographic signatures on upstream responses to protect against DNS spoofing and cache poisoning attacks. When enabled, Ferrous DNS rejects responses that fail signature verification.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">Requires upstream servers that support DNSSEC. May slightly increase response latency due to signature validation overhead.</p>
                </div>
                <div @click="config.dns.dnssec_enabled=!config.dns.dnssec_enabled"
                     :class="config.dns.dnssec_enabled?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="database" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Enable DNS Cache</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Stores DNS responses in memory so repeated queries are answered instantly without contacting upstream servers. Dramatically reduces resolution latency for frequently accessed domains.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">Disable only for debugging purposes. Detailed cache configuration is available in the Cache Settings tab.</p>
                </div>
                <div @click="config.dns.cache_enabled=!config.dns.cache_enabled"
                     :class="config.dns.cache_enabled?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
                <i data-lucide="book-open" style="width:20px;height:20px;color:var(--color-primary)"></i>
                <h2 style="font-size:18px;font-weight:700;color:var(--text-primary);margin:0">Protocol Reference</h2>
            </div>
            <p style="font-size:13px;color:var(--text-secondary);margin:0 0 20px">URL schemes accepted in the server address fields below.</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(107,114,128,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="radio" style="width:18px;height:18px;color:#6B7280"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">UDP</h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">8.8.8.8:53</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">Standard DNS. Default when no scheme is specified. Highest performance but no encryption.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(239,68,68,0.12);color:#EF4444;font-weight:500">Unencrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(16,185,129,0.12);color:#10B981;font-weight:500">Fastest</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 53</span>
                    </div>
                </div>
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(107,114,128,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="network" style="width:18px;height:18px;color:#6B7280"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">TCP</h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">tcp://8.8.8.8:53</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">Standard DNS over TCP. Fallback for large responses that exceed UDP packet limits.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(239,68,68,0.12);color:#EF4444;font-weight:500">Unencrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(245,158,11,0.12);color:#F59E0B;font-weight:500">Reliable</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 53</span>
                    </div>
                </div>
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(16,185,129,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="lock" style="width:18px;height:18px;color:#10B981"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">TLS <span style="font-weight:400;color:var(--text-tertiary);font-size:12px">(DoT)</span></h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">tls://dns.google:853</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">DNS over TLS (RFC 7858). Wraps standard DNS in a TLS tunnel. Widely supported with good tooling.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(16,185,129,0.12);color:#10B981;font-weight:500">Encrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(59,130,246,0.12);color:#3B82F6;font-weight:500">TCP</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 853</span>
                    </div>
                </div>
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(59,130,246,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="globe" style="width:18px;height:18px;color:#3B82F6"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">HTTPS <span style="font-weight:400;color:var(--text-tertiary);font-size:12px">(DoH)</span></h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">https://1.1.1.1/dns-query</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">DNS over HTTPS (RFC 8484). Queries sent as HTTP/2 POST. Blends with web traffic — hard to block.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(16,185,129,0.12);color:#10B981;font-weight:500">Encrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(59,130,246,0.12);color:#3B82F6;font-weight:500">TCP · HTTP/2</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 443</span>
                    </div>
                </div>
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(168,85,247,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="zap" style="width:18px;height:18px;color:#A855F7"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">QUIC <span style="font-weight:400;color:var(--text-tertiary);font-size:12px">(DoQ)</span></h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">doq://94.140.14.14:853</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">DNS over QUIC (RFC 9250). TLS 1.3 over UDP. No head-of-line blocking. Best encrypted option overall.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(16,185,129,0.12);color:#10B981;font-weight:500">Encrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(168,85,247,0.12);color:#A855F7;font-weight:500">UDP · QUIC</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 853</span>
                    </div>
                </div>
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--bg-tertiary)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:rgba(245,158,11,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <i data-lucide="rocket" style="width:18px;height:18px;color:#F59E0B"></i>
                        </div>
                        <div>
                            <h4 style="font-weight:700;font-size:14px;margin:0;color:var(--text-primary)">H3 <span style="font-weight:400;color:var(--text-tertiary);font-size:12px">(DoH3)</span></h4>
                            <code style="font-size:11px;color:var(--text-tertiary);background:var(--bg-secondary);padding:1px 5px;border-radius:3px">h3://94.140.14.14/dns-query</code>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-secondary);margin:0 0 10px;line-height:1.5">DNS over HTTP/3. Same semantics as DoH but over QUIC. Requires UDP port 443 to be reachable.</p>
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(16,185,129,0.12);color:#10B981;font-weight:500">Encrypted</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(245,158,11,0.12);color:#F59E0B;font-weight:500">UDP · HTTP/3</span>
                        <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(107,114,128,0.15);color:var(--text-tertiary);font-weight:500">Port 443</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div>
                    <h2 style="font-size:18px;font-weight:700;color:var(--text-primary);margin:0 0 4px">Upstream DNS Pools</h2>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Groups of upstream servers used to resolve DNS queries. Each pool can have its own strategy and priority.</p>
                </div>
                <button @click="addPool()" class="btn btn-primary">
                    <i data-lucide="plus" style="width:16px;height:16px"></i> Add Pool
                </button>
            </div>
            <template x-for="(pool,idx) in config.dns.pools" :key="idx">
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-bottom:16px;background:var(--bg-tertiary)">
                    <div style="display:grid;grid-template-columns:2fr 2fr 1fr auto;gap:12px;margin-bottom:16px">
                        <div>
                            <label class="form-label">Pool Name</label>
                            <input type="text" x-model="pool.name" placeholder="google-primary">
                        </div>
                        <div>
                            <label class="form-label">Strategy</label>
                            <select x-model="pool.strategy">
                                <option value="parallel">Parallel</option>
                                <option value="balanced">Balanced</option>
                                <option value="failover">Failover</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Priority</label>
                            <input type="number" x-model.number="pool.priority" min="1" placeholder="1">
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button @click="removePool(idx)" class="btn-icon" style="padding:10px">
                                <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Servers</label>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <template x-for="(srv,sidx) in pool.servers" :key="sidx">
                                <div style="display:flex;gap:8px">
                                    <input type="text" x-model="pool.servers[sidx]" placeholder="8.8.8.8:53" style="flex:1">
                                    <div style="padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;min-width:40px;text-align:center;display:flex;align-items:center;justify-content:center">
                                        <span x-text="getServerHealth(srv)==='Healthy'?'✅':getServerHealth(srv)==='Unhealthy'?'❌':'❓'"></span>
                                    </div>
                                    <button @click="pool.servers.splice(sidx,1)" class="btn-icon" style="padding:10px">
                                        <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="pool.servers.push('')" class="btn btn-primary" style="width:fit-content">
                                <i data-lucide="plus" style="width:16px;height:16px"></i> Add Server
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            <div x-show="config.dns.pools.length===0"
                 style="text-align:center;padding:40px;color:var(--text-secondary)">
                <i data-lucide="server" style="width:48px;height:48px;margin-bottom:16px;display:block;margin-left:auto;margin-right:auto;opacity:0.5"></i>
                <p style="margin:0">No pools configured. Click "Add Pool" to create one.</p>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">Health Check Configuration</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Periodically probes each upstream server to detect failures. Unhealthy servers are automatically excluded from the pool until they recover.</p>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:32px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="timer" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Check Interval</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">How often each upstream server is probed. Lower values detect failures faster but generate more background traffic.</p>
                </div>
                <div style="flex-shrink:0;width:150px">
                    <input type="number" x-model.number="config.dns.health_check.interval_seconds" min="5" placeholder="30" style="width:100%;text-align:right">
                    <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:32px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="clock" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Probe Timeout</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Maximum time to wait for a health probe response before the attempt is counted as a failure.</p>
                </div>
                <div style="flex-shrink:0;width:150px">
                    <input type="number" x-model.number="config.dns.health_check.timeout_ms" min="100" placeholder="2000" style="width:100%;text-align:right">
                    <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">milliseconds</p>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:32px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="alert-triangle" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Failure Threshold</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Number of consecutive failed probes required before a server is marked as unhealthy and removed from the active rotation.</p>
                </div>
                <div style="flex-shrink:0;width:150px">
                    <input type="number" x-model.number="config.dns.health_check.failure_threshold" min="1" placeholder="3" style="width:100%;text-align:right">
                    <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">failures</p>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0">
                <div style="flex:1;margin-right:32px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="check-circle" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Recovery Threshold</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Number of consecutive successful probes required before a previously unhealthy server is returned to the active rotation.</p>
                </div>
                <div style="flex-shrink:0;width:150px">
                    <input type="number" x-model.number="config.dns.health_check.success_threshold" min="1" placeholder="2" style="width:100%;text-align:right">
                    <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">successes</p>
                </div>
            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save Advanced Settings
        </button>
    </div>

    <!-- CACHE SETTINGS TAB -->
    <div x-show="currentTab==='cache'&&!loading" x-cloak>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(59,130,246,0.1)">
                        <i data-lucide="database" style="width:24px;height:24px;color:#3B82F6"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Entries</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:var(--text-primary)" x-text="cacheStats.total_entries||0">0</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(16,185,129,0.1)">
                        <i data-lucide="target" style="width:24px;height:24px;color:#10B981"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Hit Rate</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#10B981" x-text="(cacheStats.hit_rate||0).toFixed(1)+'%'">0%</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(168,85,247,0.1)">
                        <i data-lucide="zap" style="width:24px;height:24px;color:#A855F7"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Hits</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#A855F7" x-text="cacheStats.total_hits||0">0</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(245,158,11,0.1)">
                        <i data-lucide="x-circle" style="width:24px;height:24px;color:#F59E0B"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Misses</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#F59E0B" x-text="cacheStats.total_misses||0">0</p>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">Cache Configuration</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Configure how DNS responses are stored and managed in memory to minimise upstream queries and latency.</p>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="database" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Enable DNS Cache</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Stores DNS responses in memory so repeated queries are answered instantly without contacting upstream servers. Dramatically reduces latency for frequently accessed domains.</p>
                </div>
                <div @click="config.dns.cache_enabled=!config.dns.cache_enabled"
                     :class="config.dns.cache_enabled?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div x-show="config.dns.cache_enabled">

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="clock" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Default Cache TTL</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Time-to-live applied to cached entries that carry no TTL of their own. Does not override TTLs already present in upstream responses.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_ttl" min="1" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="chevrons-down" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Minimum Cache TTL</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Floor applied to every cached entry. Upstream values below this threshold are raised to this minimum. Recommended ≥ 240 seconds to prevent excessive upstream queries.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_min_ttl" min="0" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="chevrons-up" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Maximum Cache TTL</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Ceiling applied to every cached entry. Upstream values above this limit are capped to this maximum. Prevents stale entries from persisting indefinitely in the cache.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_max_ttl" min="1" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="layers" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Maximum Cache Size</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Upper limit on the number of DNS records held in memory. When full, the configured eviction strategy determines which entries are removed to make room for new ones.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_max_entries" min="100" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">entries</p>
                    </div>
                </div>

                <div style="padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="filter" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Eviction Strategy</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0 0 16px">Algorithm used to select which cache entries are removed when the cache reaches its size limit.</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                        <div :style="config.dns.cache_eviction_strategy==='lru'?'border:2px solid #10B981;background:rgba(16,185,129,0.07)':'border:1px solid var(--border-color);background:var(--bg-tertiary)'"
                             style="border-radius:16px;padding:18px;cursor:pointer" @click="config.dns.cache_eviction_strategy='lru'">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <i data-lucide="clock-3" style="width:16px;height:16px;color:#F59E0B"></i>
                                <span style="font-size:13px;font-weight:600">LRU — Least Recently Used</span>
                            </div>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0;line-height:1.5">Removes the entry that was accessed least recently. Simple and predictable — entries not queried for a while are first to go. Well suited for workloads where recent access reliably predicts future demand.</p>
                        </div>
                        <div :style="config.dns.cache_eviction_strategy==='lfu'?'border:2px solid #10B981;background:rgba(16,185,129,0.07)':'border:1px solid var(--border-color);background:var(--bg-tertiary)'"
                             style="border-radius:16px;padding:18px;cursor:pointer" @click="config.dns.cache_eviction_strategy='lfu'">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <i data-lucide="bar-chart" style="width:16px;height:16px;color:#A855F7"></i>
                                <span style="font-size:13px;font-weight:600">LFU — Least Frequently Used</span>
                            </div>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0;line-height:1.5">Removes entries with the lowest total hit count. Keeps the most-queried domains in cache indefinitely. May cause cache pollution where old popular entries crowd out newer, more relevant ones.</p>
                        </div>
                        <div :style="config.dns.cache_eviction_strategy==='lfu-k'?'border:2px solid #10B981;background:rgba(16,185,129,0.07)':'border:1px solid var(--border-color);background:var(--bg-tertiary)'"
                             style="border-radius:16px;padding:18px;cursor:pointer" @click="config.dns.cache_eviction_strategy='lfu-k'">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <i data-lucide="activity" style="width:16px;height:16px;color:#3B82F6"></i>
                                <span style="font-size:13px;font-weight:600">LFU-K — Adaptive</span>
                            </div>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0;line-height:1.5">Uses the K most recent access timestamps to compute frequency, making it responsive to shifting access patterns. Balances LFU's popularity bias with LRU's recency awareness for adaptive workloads.</p>
                        </div>
                        <div :style="config.dns.cache_eviction_strategy==='hit_rate'?'border:2px solid #10B981;background:rgba(16,185,129,0.07)':'border:1px solid var(--border-color);background:var(--bg-tertiary)'"
                             style="border-radius:16px;padding:18px;cursor:pointer" @click="config.dns.cache_eviction_strategy='hit_rate'">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <i data-lucide="target" style="width:16px;height:16px;color:#10B981"></i>
                                <span style="font-size:13px;font-weight:600">Hit Rate Based &nbsp;<span style="font-size:11px;color:#10B981;font-weight:500">(recommended)</span></span>
                            </div>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0;line-height:1.5">Scores entries by hits relative to their TTL. A frequently queried short-TTL record scores higher than one with equal hits but a longer TTL. Ideal for DNS — correctly values CDN and dynamic records that matter most.</p>
                        </div>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:24px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="refresh-cw" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Optimistic Refresh</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Proactively re-fetches cache entries in the background before they expire, so clients always receive a fresh response with zero added latency. Triggered when a cached entry has consumed more than the configured Refresh Threshold of its TTL.</p>
                        <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">Only applies to entries that meet the Minimum Hit Rate and Minimum Frequency thresholds below.</p>
                    </div>
                    <div @click="config.dns.cache_optimistic_refresh=!config.dns.cache_optimistic_refresh"
                         :class="config.dns.cache_optimistic_refresh?'active':''" class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div x-show="config.dns.cache_optimistic_refresh">
                    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                        <div style="flex:1;margin-right:32px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                                <i data-lucide="gauge" style="width:20px;height:20px;color:var(--color-primary)"></i>
                                <h4 style="font-size:16px;font-weight:600;margin:0">Refresh Threshold</h4>
                            </div>
                            <p style="font-size:13px;color:var(--text-secondary);margin:0">Fraction of a cache entry's TTL that must have elapsed before a background refresh is triggered. A value of <code style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">0.75</code> means the entry is refreshed when 75% of its TTL has passed.</p>
                        </div>
                        <div style="flex-shrink:0;width:150px">
                            <input type="number" x-model.number="config.dns.cache_refresh_threshold" step="0.05" min="0.1" max="0.99" style="width:100%;text-align:right">
                            <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">0.1 – 0.99</p>
                        </div>
                    </div>
                </div>

                <div x-show="config.dns.cache_optimistic_refresh">
                    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                        <div style="flex:1;margin-right:32px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                                <i data-lucide="bar-chart-2" style="width:20px;height:20px;color:var(--color-primary)"></i>
                                <h4 style="font-size:16px;font-weight:600;margin:0">Minimum Hit Rate</h4>
                            </div>
                            <p style="font-size:13px;color:var(--text-secondary);margin:0">Minimum cache hits per minute an entry must receive to qualify for optimistic refresh. Entries accessed less frequently are allowed to expire normally and are only re-fetched on the next client request.</p>
                        </div>
                        <div style="flex-shrink:0;width:150px">
                            <input type="number" x-model.number="config.dns.cache_min_hit_rate" step="0.1" min="0" style="width:100%;text-align:right">
                            <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">hits / min</p>
                        </div>
                    </div>
                </div>

                <div x-show="config.dns.cache_optimistic_refresh">
                    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                        <div style="flex:1;margin-right:32px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                                <i data-lucide="hash" style="width:20px;height:20px;color:var(--color-primary)"></i>
                                <h4 style="font-size:16px;font-weight:600;margin:0">Minimum Frequency</h4>
                            </div>
                            <p style="font-size:13px;color:var(--text-secondary);margin:0">Minimum total number of hits an entry must accumulate before it is eligible for optimistic refresh. Prevents very recently added entries from being immediately scheduled for background re-fetches.</p>
                        </div>
                        <div style="flex-shrink:0;width:150px">
                            <input type="number" x-model.number="config.dns.cache_min_frequency" min="1" style="width:100%;text-align:right">
                            <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">total hits</p>
                        </div>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="calendar" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Access Window</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Time window within which an entry must have been accessed at least once to remain eligible for optimistic refresh. Entries not accessed within this window will expire normally rather than being proactively renewed.</p>
                        <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">Example: 7200 = 2 h &nbsp;·&nbsp; 43200 = 12 h &nbsp;·&nbsp; 86400 = 24 h.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_access_window_secs" min="0" step="3600" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                    <div style="flex:1;margin-right:24px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="sliders" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Adaptive Thresholds</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Automatically tunes eviction thresholds based on observed cache behaviour. When enabled, Ferrous DNS continuously adjusts Min Hit Rate and Min Frequency to maintain an optimal working set without manual tuning.</p>
                        <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">When enabled, the manually configured Min Hit Rate and Min Frequency values are overridden by the adaptive engine.</p>
                    </div>
                    <div @click="config.dns.cache_adaptive_thresholds=!config.dns.cache_adaptive_thresholds"
                         :class="config.dns.cache_adaptive_thresholds?'active':''" class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0">
                    <div style="flex:1;margin-right:32px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="archive" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Compaction Interval</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">Interval between full cache compaction passes that scan for and remove all expired entries. Lower values free memory more promptly; higher values reduce CPU overhead at the cost of holding stale entries slightly longer.</p>
                    </div>
                    <div style="flex-shrink:0;width:150px">
                        <input type="number" x-model.number="config.dns.cache_compaction_interval" min="60" style="width:100%;text-align:right">
                        <p style="font-size:11px;color:var(--text-tertiary);margin:4px 0 0;text-align:right">seconds</p>
                    </div>
                </div>

            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save Cache Settings
        </button>
    </div>

    <!-- WEB INTERFACE TAB -->
    <div x-show="currentTab==='webinterface'&&!loading" x-cloak>
        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">Appearance</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Choose the color scheme for the web interface</p>
            <div class="form-group" style="max-width:240px">
                <label class="form-label">Theme</label>
                <select x-model="theme"
                        @change="localStorage.setItem('theme', theme); document.documentElement.classList.toggle('dark', theme === 'dark'); scheduleLucide()">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>
    </div>

</main>

<script>
    function app() {
        return {
            theme: 'light',
            currentTab: 'dnsbasic',
            loading: true,
            stats: {queries_total: 0},
            config: {
                dns: {
                    pools: [],
                    health_check: {enabled: true, interval_seconds: 30, timeout_ms: 2000, failure_threshold: 3},
                    dnssec_enabled: false,
                    cache_enabled: true,
                    cache_ttl: 3600,
                    cache_min_ttl: 0,
                    cache_max_ttl: 86400,
                    cache_max_entries: 10000,
                    cache_eviction_strategy: 'lfu',
                    cache_min_hit_rate: 0.3,
                    cache_refresh_threshold: 0.8,
                    cache_compaction_interval: 300,
                    cache_optimistic_refresh: true,
                    cache_adaptive_thresholds: true,
                    cache_access_window_secs: 7200
                }
            },
            settings: {
                never_forward_non_fqdn: false,
                never_forward_reverse_lookups: false,
                local_domain: '',
                local_dns_server: ''
            },
            cacheStats: {total_entries: 0, hit_rate: 0, total_hits: 0, total_misses: 0},
            healthStatus: {},
            restartRequired: false,
            alert: {show: false, type: 'success', message: ''},
            async init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadConfig(), this.loadDnsSettings(), this.loadHealthStatus(), this.loadCacheStats(), this.loadStats()]);
                scheduleLucide(100);
                this.startPolling();
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.stopPolling();
                    else this.startPolling();
                });
            },
            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                setTimeout(() => lucide.createIcons(), 50)
            },
            _ctrl: {},
            _pollId: null,
            startPolling() {
                this.stopPolling();
                this._pollId = setInterval(() => {
                    this.loadHealthStatus();
                    this.loadStats();
                }, 10000);
            },
            stopPolling() {
                clearInterval(this._pollId);
                this._pollId = null;
            },
            async loadStats() {
                this._ctrl.stats?.abort();
                this._ctrl.stats = new AbortController();
                try {
                    const r = await fetch('/api/stats', {signal: this._ctrl.stats.signal});
                    if (r.ok) this.stats = await r.json()
                } catch (e) {
                    if (e.name !== 'AbortError') console.error(e)
                }
            },
            async loadConfig() {
                try {
                    this.loading = true;
                    const res = await fetch('/api/config');
                    if (res.ok) {
                        const data = await res.json();
                        this.config = {
                            ...this.config, ...data,
                            dns: {
                                ...this.config.dns, ...(data.dns || {}),
                                pools: data.dns?.pools || [],
                                health_check: {
                                    enabled: data.dns?.health_check?.enabled ?? true,
                                    interval_seconds: data.dns?.health_check?.interval_seconds ?? 30,
                                    timeout_ms: data.dns?.health_check?.timeout_ms ?? 2000,
                                    failure_threshold: data.dns?.health_check?.failure_threshold ?? 3
                                },
                                cache_ttl: data.dns?.cache_ttl ?? 3600,
                                cache_min_ttl: data.dns?.cache_min_ttl ?? 0,
                                cache_max_ttl: data.dns?.cache_max_ttl ?? 86400,
                                cache_max_entries: data.dns?.cache_max_entries ?? 10000,
                                cache_eviction_strategy: data.dns?.cache_eviction_strategy ?? 'lfu',
                                cache_min_hit_rate: data.dns?.cache_min_hit_rate ?? 0.3,
                                cache_refresh_threshold: data.dns?.cache_refresh_threshold ?? 0.8,
                                cache_compaction_interval: data.dns?.cache_compaction_interval ?? 300,
                                cache_optimistic_refresh: data.dns?.cache_optimistic_refresh ?? true,
                                cache_adaptive_thresholds: data.dns?.cache_adaptive_thresholds ?? true,
                                cache_access_window_secs: data.dns?.cache_access_window_secs ?? 7200
                            }
                        };
                        if (this.config.dns.pools.length === 0 && data.dns?.upstream_servers?.length > 0) {
                            this.config.dns.pools = [{
                                name: 'default',
                                strategy: 'parallel',
                                priority: 1,
                                servers: [...data.dns.upstream_servers]
                            }]
                        }
                    } else {
                        this.showAlert('error', 'Failed to load configuration')
                    }
                } catch (e) {
                    console.error('Load config error:', e);
                    this.showAlert('error', 'Failed to load: ' + e.message)
                } finally {
                    this.loading = false
                }
            },
            async loadDnsSettings() {
                try {
                    const r = await fetch('/api/settings');
                    if (r.ok) this.settings = await r.json()
                } catch (e) {
                    console.log('Using default DNS settings', e)
                }
            },
            async loadHealthStatus() {
                this._ctrl.health?.abort();
                this._ctrl.health = new AbortController();
                try {
                    const res = await fetch('/api/health/upstreams', {signal: this._ctrl.health.signal});
                    if (res.ok) this.healthStatus = await res.json()
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Load health error:', e)
                }
            },
            async loadCacheStats() {
                try {
                    const res = await fetch('/api/cache/stats');
                    if (res.ok) this.cacheStats = await res.json()
                } catch (e) {
                    console.error('Load cache stats error:', e)
                }
            },
            getServerHealth(s) {
                return this.healthStatus[s] || 'Unknown'
            },
            addPool() {
                this.config.dns.pools.push({name: '', strategy: 'parallel', priority: 1, servers: ['']});
                setTimeout(() => lucide.createIcons(), 50)
            },
            removePool(idx) {
                this.config.dns.pools.splice(idx, 1)
            },
            getFirstPoolStrategy() {
                return this.config.dns.pools[0]?.strategy || 'parallel'
            },
            setFirstPoolStrategy(s) {
                if (this.config.dns.pools.length > 0) {
                    this.config.dns.pools[0].strategy = s
                } else {
                    this.addPool();
                    this.config.dns.pools[0].strategy = s
                }
            },
            async saveConfig() {
                try {
                    const res = await fetch('/api/config', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.config)
                    });
                    if (res.ok) {
                        this.showAlert('success', 'Configuration saved successfully!')
                    } else {
                        const err = await res.text();
                        this.showAlert('error', 'Failed to save: ' + err)
                    }
                } catch (e) {
                    this.showAlert('error', 'Failed to save: ' + e.message)
                }
            },
            async saveDnsSettings() {
                try {
                    const r = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.settings)
                    });
                    if (r.ok) {
                        const data = await r.json();
                        this.showAlert('success', 'DNS settings saved!');
                        if (data.message.includes('restart')) {
                            this.restartRequired = true
                        }
                    } else {
                        const error = await r.json();
                        this.showAlert('error', 'Failed: ' + (error.message || 'Unknown error'))
                    }
                } catch (e) {
                    console.error(e);
                    this.showAlert('error', 'Error: ' + e.message)
                }
            },
            toggleLocalDomain() {
                if (this.settings.local_domain) {
                    this.settings.local_domain = '';
                    this.settings.local_dns_server = '';
                } else {
                    this.settings.local_domain = 'lan';
                }
            },
            showAlert(type, msg) {
                this.alert = {show: true, type, message: msg};
                setTimeout(() => {
                    this.alert.show = false
                }, 5000)
            }
        }
    }
</script>
</body>
</html>
