<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif
        }

        .card {
            padding: 24px;
            margin-bottom: 24px
        }

        .card-stat {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all .2s
        }

        .card-stat:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px)
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 8px
        }

        .btn-primary { background: var(--color-primary); color: white }
        .btn-primary:hover { background: #2563EB }
        .btn-success { background: var(--color-success); color: white }
        .btn-success:hover { background: #059669 }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary) }
        .btn-secondary:hover { background: var(--border-color) }

        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s
        }

        .btn-icon:hover { background: var(--bg-tertiary); color: var(--text-primary) }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px
        }

        .tab-btn {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all .15s
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary)
        }

        .tab-btn:hover { color: var(--text-primary) }

        .strategy-card {
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            transition: all .2s;
            cursor: pointer;
            background: var(--bg-secondary)
        }

        .strategy-card:hover { border-color: var(--color-primary) }

        .strategy-card.selected {
            border-color: var(--color-primary);
            background: rgba(59, 130, 246, 0.05)
        }

        .input, select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box
        }

        .input:focus, select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--color-primary)
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary)
        }

        .form-group { margin-bottom: 16px }

        label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .alert-success {
            background: #ECFDF5;
            border: 1px solid #10B981;
            color: #065F46
        }

        .alert-error {
            background: #FEF2F2;
            border: 1px solid #EF4444;
            color: #991B1B
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--text-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background .3s;
            flex-shrink: 0
        }

        .toggle-switch.active { background: var(--color-success) }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform .3s
        }

        .toggle-switch.active .toggle-slider { transform: translateX(24px) }

        @keyframes spin {
            to { transform: rotate(360deg) }
        }
    </style>
</head>
<body x-data="app()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span></div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span>
        </div>
        <div class="status-item">
            <i data-lucide="zap" style="width:14px;height:14px"></i>
            <span x-text="stats.queries_total+' queries'">Running</span>
        </div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item"><i data-lucide="file-text" class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item"><i data-lucide="hard-drive" class="nav-icon"></i><span>Local DNS</span></a>
            <a href="/settings.html" class="nav-item active"><i data-lucide="settings" class="nav-icon"></i><span>Settings</span></a>
        </div>
    </nav>
    <div class="sidebar-footer">
        <button @click="toggleTheme()" class="theme-btn">
            <i data-lucide="sun" x-show="theme==='light'" style="width:16px;height:16px"></i>
            <i data-lucide="moon" x-show="theme==='dark'" style="width:16px;height:16px"></i>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main style="padding:24px">

    <div style="margin-bottom:24px">
        <h1 style="font-size:28px;font-weight:700;margin-bottom:4px;color:var(--text-primary)">Settings</h1>
        <p style="font-size:14px;color:var(--text-secondary)">Configure DNS server behavior, upstream pools, and cache settings</p>
    </div>

    <div x-show="restartRequired" x-cloak
         style="background:#FEF3C7;border:1px solid #F59E0B;border-radius:8px;padding:12px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
        <i data-lucide="alert-triangle" style="width:20px;height:20px;color:#F59E0B;flex-shrink:0"></i>
        <p style="font-size:14px;color:#92400E;margin:0;font-weight:500">Server restart required for settings to take effect</p>
    </div>

    <div x-show="alert.show" :class="alert.type==='success'?'alert-success':'alert-error'" class="alert" x-cloak>
        <strong x-text="alert.message"></strong>
        <button @click="alert.show=false" style="font-size:20px;font-weight:700;background:none;border:none;cursor:pointer">&times;</button>
    </div>

    <div x-show="loading" x-cloak style="text-align:center;padding:40px">
        <div style="display:inline-block;width:40px;height:40px;border:4px solid var(--border-color);border-top-color:var(--color-primary);border-radius:50%;animation:spin 1s linear infinite"></div>
        <p style="margin-top:16px;color:var(--text-secondary)">Loading configuration...</p>
    </div>

    <div x-show="!loading" class="tab-bar">
        <button @click="currentTab='dnsbasic';scheduleLucide()"
                :class="currentTab==='dnsbasic'?'tab-btn active':'tab-btn'">DNS Settings</button>
        <button @click="currentTab='dnsadvanced';scheduleLucide()"
                :class="currentTab==='dnsadvanced'?'tab-btn active':'tab-btn'">DNS Advanced</button>
        <button @click="currentTab='cache';scheduleLucide()"
                :class="currentTab==='cache'?'tab-btn active':'tab-btn'">Cache Settings</button>
    </div>

    <!-- DNS SETTINGS TAB -->
    <div x-show="currentTab==='dnsbasic'&&!loading" x-cloak>
        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">DNS Settings</h2>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px">Configure advanced DNS behavior</p>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="shield-off" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward non-FQDN queries</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">Tells Ferrous DNS to never forward
                        queries for plain names, without dots or domain parts, to upstream nameservers. If the name is
                        not known from <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or DHCP then a "not found" answer is returned.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0;font-style:italic">If Conditional
                        Forwarding is enabled, unticking this box may cause a partial loop.</p>
                </div>
                <div @click="settings.never_forward_non_fqdn=!settings.never_forward_non_fqdn"
                     :class="settings.never_forward_non_fqdn?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border-color)">
                <div style="flex:1;margin-right:24px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <i data-lucide="lock" style="width:20px;height:20px;color:var(--color-primary)"></i>
                        <h4 style="font-size:16px;font-weight:600;margin:0">Never forward reverse lookups for private IP ranges</h4>
                    </div>
                    <p style="font-size:13px;color:var(--text-secondary);margin:0">All reverse lookups for private IP
                        ranges (i.e., <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">192.168.0.x/24</code>,
                        etc.) which are not found in <code style="padding:2px 6px;background:var(--bg-tertiary);border-radius:4px">local-records</code>
                        or the DHCP leases are answered with "no such domain" rather than being forwarded upstream.</p>
                    <p style="font-size:12px;color:var(--text-tertiary);margin:8px 0 0">The set of prefixes affected is
                        the list given in <a href="https://tools.ietf.org/html/rfc6303" style="color:var(--color-primary)" target="_blank">RFC6303</a>.</p>
                </div>
                <div @click="settings.never_forward_reverse_lookups=!settings.never_forward_reverse_lookups"
                     :class="settings.never_forward_reverse_lookups?'active':''" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>

            <div style="padding:16px 0">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px">
                    <div style="flex:1;margin-right:24px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <i data-lucide="git-branch" style="width:20px;height:20px;color:var(--color-primary)"></i>
                            <h4 style="font-size:16px;font-weight:600;margin:0">Use Conditional Forwarding</h4>
                        </div>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0">If not configured as your DHCP
                            server, Ferrous DNS typically won't be able to determine the names of devices on your local
                            network. As a result, tables such as Top Clients will only show IP addresses.</p>
                        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 0">One solution is to
                            configure Ferrous DNS to forward these requests to your DHCP server (most likely your
                            router), but only for devices on your home network.</p>
                    </div>
                    <div @click="toggleConditionalForwarding()"
                         :class="settings.conditional_forwarding_enabled?'active':''" class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div x-show="settings.conditional_forwarding_enabled" x-cloak
                     style="border-top:1px solid var(--border-color);padding-top:16px">
                    <div class="form-group">
                        <label class="form-label">Local domain name <span style="color:var(--text-tertiary);font-weight:400">(optional)</span></label>
                        <input type="text" x-model="settings.local_domain" placeholder="fritz.box"
                               style="max-width:400px;font-family:monospace">
                        <p style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Like <code
                                style="padding:1px 4px;background:var(--bg-tertiary);border-radius:3px">fritz.box</code>
                            to ensure queries to devices ending in your local domain name won't leave your network</p>
                    </div>
                </div>
            </div>
        </div>

        <button @click="saveDnsSettings()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save DNS Settings
        </button>
    </div>

    <!-- DNS ADVANCED TAB -->
    <div x-show="currentTab==='dnsadvanced'&&!loading" x-cloak>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">
            <div class="strategy-card" :class="getFirstPoolStrategy()==='parallel'?'selected':''"
                 @click="setFirstPoolStrategy('parallel')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="zap" style="width:28px;height:28px;color:#A855F7"></i>
                    <h3 style="font-weight:700;font-size:16px">Parallel</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Sends query to all upstreams, returns fastest response</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#10B981">Best</strong></span>
                    <span>Network: <strong style="color:#EF4444">High</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='balanced'?'selected':''"
                 @click="setFirstPoolStrategy('balanced')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="scale" style="width:28px;height:28px;color:#3B82F6"></i>
                    <h3 style="font-weight:700;font-size:16px">Balanced</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Round-robin load distribution across upstreams</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong style="color:#F59E0B">Medium</strong></span>
                    <span>Network: <strong style="color:#F59E0B">Medium</strong></span>
                </div>
            </div>
            <div class="strategy-card" :class="getFirstPoolStrategy()==='failover'?'selected':''"
                 @click="setFirstPoolStrategy('failover')">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <i data-lucide="arrow-down" style="width:28px;height:28px;color:#10B981"></i>
                    <h3 style="font-weight:700;font-size:16px">Failover</h3>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Primary server, switch on failure</p>
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-tertiary)">
                    <span>Latency: <strong>Depends</strong></span>
                    <span>Network: <strong style="color:#10B981">Low</strong></span>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2 style="font-size:18px;font-weight:700;color:var(--text-primary)">Upstream DNS Pools</h2>
                <button @click="addPool()" class="btn btn-primary">
                    <i data-lucide="plus" style="width:16px;height:16px"></i> Add Pool
                </button>
            </div>
            <template x-for="(pool,idx) in config.dns.pools" :key="idx">
                <div style="border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-bottom:16px;background:var(--bg-tertiary)">
                    <div style="display:grid;grid-template-columns:2fr 2fr 1fr auto;gap:12px;margin-bottom:16px">
                        <div>
                            <label class="form-label">Pool Name</label>
                            <input type="text" x-model="pool.name" placeholder="google-primary">
                        </div>
                        <div>
                            <label class="form-label">Strategy</label>
                            <select x-model="pool.strategy">
                                <option value="parallel">Parallel</option>
                                <option value="balanced">Balanced</option>
                                <option value="failover">Failover</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Priority</label>
                            <input type="number" x-model.number="pool.priority" min="1" placeholder="1">
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button @click="removePool(idx)" class="btn-icon" style="padding:10px">
                                <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Servers</label>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <template x-for="(srv,sidx) in pool.servers" :key="sidx">
                                <div style="display:flex;gap:8px">
                                    <input type="text" x-model="pool.servers[sidx]" placeholder="8.8.8.8:53" style="flex:1">
                                    <div style="padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;min-width:40px;text-align:center;display:flex;align-items:center;justify-content:center">
                                        <span x-text="getServerHealth(srv)==='Healthy'?'✅':getServerHealth(srv)==='Unhealthy'?'❌':'❓'"></span>
                                    </div>
                                    <button @click="pool.servers.splice(sidx,1)" class="btn-icon" style="padding:10px">
                                        <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="pool.servers.push('')" class="btn btn-primary" style="width:fit-content">
                                <i data-lucide="plus" style="width:16px;height:16px"></i> Add Server
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            <div x-show="config.dns.pools.length===0"
                 style="text-align:center;padding:40px;color:var(--text-secondary)">
                <i data-lucide="server" style="width:48px;height:48px;margin-bottom:16px;display:block;margin-left:auto;margin-right:auto;opacity:0.5"></i>
                <p style="margin:0">No pools configured. Click "Add Pool" to create one.</p>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text-primary)">Health Check Configuration</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div style="grid-column:1/-1">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" x-model="config.dns.health_check.enabled"
                               style="width:18px;height:18px;accent-color:var(--color-primary)">
                        <span>Enable Health Checking</span>
                    </label>
                </div>
                <div x-show="config.dns.health_check.enabled">
                    <label class="form-label">Interval (seconds)</label>
                    <input type="number" x-model.number="config.dns.health_check.interval_seconds">
                </div>
                <div x-show="config.dns.health_check.enabled">
                    <label class="form-label">Timeout (ms)</label>
                    <input type="number" x-model.number="config.dns.health_check.timeout_ms">
                </div>
                <div x-show="config.dns.health_check.enabled">
                    <label class="form-label">Failure Threshold</label>
                    <input type="number" x-model.number="config.dns.health_check.failure_threshold">
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text-primary)">General DNS Settings</h2>
            <div style="display:flex;flex-direction:column;gap:12px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" x-model="config.dns.dnssec_enabled"
                           style="width:18px;height:18px;accent-color:var(--color-primary)">
                    <span>Enable DNSSEC Validation</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" x-model="config.dns.cache_enabled"
                           style="width:18px;height:18px;accent-color:var(--color-primary)">
                    <span>Enable DNS Cache</span>
                </label>
            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save Advanced Settings
        </button>
    </div>

    <!-- CACHE SETTINGS TAB -->
    <div x-show="currentTab==='cache'&&!loading" x-cloak>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(59,130,246,0.1)">
                        <i data-lucide="database" style="width:24px;height:24px;color:#3B82F6"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Entries</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:var(--text-primary)" x-text="cacheStats.total_entries||0">0</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(16,185,129,0.1)">
                        <i data-lucide="target" style="width:24px;height:24px;color:#10B981"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Hit Rate</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#10B981" x-text="(cacheStats.hit_rate||0).toFixed(1)+'%'">0%</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(168,85,247,0.1)">
                        <i data-lucide="zap" style="width:24px;height:24px;color:#A855F7"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Hits</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#A855F7" x-text="cacheStats.total_hits||0">0</p>
            </div>
            <div class="card-stat">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                    <div style="padding:12px;border-radius:8px;background:rgba(245,158,11,0.1)">
                        <i data-lucide="x-circle" style="width:24px;height:24px;color:#F59E0B"></i>
                    </div>
                    <p style="font-size:14px;font-weight:500;color:var(--text-secondary)">Total Misses</p>
                </div>
                <p style="font-size:32px;font-weight:700;color:#F59E0B" x-text="cacheStats.total_misses||0">0</p>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text-primary)">Cache Configuration</h2>

            <div style="margin-bottom:20px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" x-model="config.dns.cache_enabled"
                           style="width:18px;height:18px;accent-color:var(--color-primary)">
                    <span style="font-weight:500">Enable DNS Cache</span>
                </label>
            </div>

            <div x-show="config.dns.cache_enabled">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
                    <div class="form-group">
                        <label class="form-label">Cache TTL (seconds)</label>
                        <input type="number" x-model.number="config.dns.cache_ttl" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Cache Entries</label>
                        <input type="number" x-model.number="config.dns.cache_max_entries" min="100">
                    </div>
                </div>

                <div style="border-top:1px solid var(--border-color);padding-top:20px">
                    <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;color:var(--text-primary)">Advanced Settings</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                        <div class="form-group">
                            <label class="form-label">Eviction Strategy</label>
                            <select x-model="config.dns.cache_eviction_strategy">
                                <option value="lru">LRU (Least Recently Used)</option>
                                <option value="lfu">LFU (Least Frequently Used)</option>
                                <option value="lfu-k">LFU-K (Adaptive)</option>
                                <option value="hit-rate">Hit Rate Based</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Min Hit Rate</label>
                            <input type="number" x-model.number="config.dns.cache_min_hit_rate" step="0.1" min="0" max="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Refresh Threshold</label>
                            <input type="number" x-model.number="config.dns.cache_refresh_threshold" step="0.1" min="0" max="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Compaction Interval (s)</label>
                            <input type="number" x-model.number="config.dns.cache_compaction_interval" min="60">
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" x-model="config.dns.cache_optimistic_refresh"
                                   style="width:18px;height:18px;accent-color:var(--color-primary)">
                            <span>Enable Optimistic Refresh</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" x-model="config.dns.cache_adaptive_thresholds"
                                   style="width:18px;height:18px;accent-color:var(--color-primary)">
                            <span>Enable Adaptive Thresholds</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <button @click="saveConfig()" class="btn btn-success">
            <i data-lucide="save" style="width:16px;height:16px"></i> Save Cache Settings
        </button>
    </div>

</main>

<script>
    function app() {
        return {
            theme: 'light',
            currentTab: 'dnsbasic',
            loading: true,
            stats: {queries_total: 0},
            config: {
                dns: {
                    pools: [],
                    health_check: {enabled: true, interval_seconds: 30, timeout_ms: 2000, failure_threshold: 3},
                    dnssec_enabled: false,
                    cache_enabled: true,
                    cache_ttl: 3600,
                    cache_max_entries: 10000,
                    cache_eviction_strategy: 'lfu',
                    cache_min_hit_rate: 0.3,
                    cache_refresh_threshold: 0.8,
                    cache_compaction_interval: 300,
                    cache_optimistic_refresh: true,
                    cache_adaptive_thresholds: true
                }
            },
            settings: {
                never_forward_non_fqdn: false,
                never_forward_reverse_lookups: false,
                conditional_forwarding_enabled: false,
                local_domain: ''
            },
            cacheStats: {total_entries: 0, hit_rate: 0, total_hits: 0, total_misses: 0},
            healthStatus: {},
            restartRequired: false,
            alert: {show: false, type: 'success', message: ''},
            async init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadConfig(), this.loadDnsSettings(), this.loadHealthStatus(), this.loadCacheStats(), this.loadStats()]);
                scheduleLucide(100);
                this.startPolling();
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.stopPolling();
                    else this.startPolling();
                });
            },
            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                setTimeout(() => lucide.createIcons(), 50)
            },
            _ctrl: {},
            _pollId: null,
            startPolling() {
                this.stopPolling();
                this._pollId = setInterval(() => {
                    this.loadHealthStatus();
                    this.loadStats();
                }, 10000);
            },
            stopPolling() {
                clearInterval(this._pollId);
                this._pollId = null;
            },
            async loadStats() {
                this._ctrl.stats?.abort();
                this._ctrl.stats = new AbortController();
                try {
                    const r = await fetch('/api/stats', {signal: this._ctrl.stats.signal});
                    if (r.ok) this.stats = await r.json()
                } catch (e) {
                    if (e.name !== 'AbortError') console.error(e)
                }
            },
            async loadConfig() {
                try {
                    this.loading = true;
                    const res = await fetch('/api/config');
                    if (res.ok) {
                        const data = await res.json();
                        this.config = {
                            ...this.config, ...data,
                            dns: {
                                ...this.config.dns, ...(data.dns || {}),
                                pools: data.dns?.pools || [],
                                health_check: {
                                    enabled: data.dns?.health_check?.enabled ?? true,
                                    interval_seconds: data.dns?.health_check?.interval_seconds ?? 30,
                                    timeout_ms: data.dns?.health_check?.timeout_ms ?? 2000,
                                    failure_threshold: data.dns?.health_check?.failure_threshold ?? 3
                                },
                                cache_ttl: data.dns?.cache_ttl ?? 3600,
                                cache_max_entries: data.dns?.cache_max_entries ?? 10000,
                                cache_eviction_strategy: data.dns?.cache_eviction_strategy ?? 'lfu',
                                cache_min_hit_rate: data.dns?.cache_min_hit_rate ?? 0.3,
                                cache_refresh_threshold: data.dns?.cache_refresh_threshold ?? 0.8,
                                cache_compaction_interval: data.dns?.cache_compaction_interval ?? 300,
                                cache_optimistic_refresh: data.dns?.cache_optimistic_refresh ?? true,
                                cache_adaptive_thresholds: data.dns?.cache_adaptive_thresholds ?? true
                            }
                        };
                        if (this.config.dns.pools.length === 0 && data.dns?.upstream_servers?.length > 0) {
                            this.config.dns.pools = [{
                                name: 'default',
                                strategy: 'parallel',
                                priority: 1,
                                servers: [...data.dns.upstream_servers]
                            }]
                        }
                    } else {
                        this.showAlert('error', 'Failed to load configuration')
                    }
                } catch (e) {
                    console.error('Load config error:', e);
                    this.showAlert('error', 'Failed to load: ' + e.message)
                } finally {
                    this.loading = false
                }
            },
            async loadDnsSettings() {
                try {
                    const r = await fetch('/api/settings');
                    if (r.ok) this.settings = await r.json()
                } catch (e) {
                    console.log('Using default DNS settings', e)
                }
            },
            async loadHealthStatus() {
                this._ctrl.health?.abort();
                this._ctrl.health = new AbortController();
                try {
                    const res = await fetch('/api/health/upstreams', {signal: this._ctrl.health.signal});
                    if (res.ok) this.healthStatus = await res.json()
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Load health error:', e)
                }
            },
            async loadCacheStats() {
                try {
                    const res = await fetch('/api/cache/stats');
                    if (res.ok) this.cacheStats = await res.json()
                } catch (e) {
                    console.error('Load cache stats error:', e)
                }
            },
            getServerHealth(s) {
                return this.healthStatus[s] || 'Unknown'
            },
            addPool() {
                this.config.dns.pools.push({name: '', strategy: 'parallel', priority: 1, servers: ['']});
                setTimeout(() => lucide.createIcons(), 50)
            },
            removePool(idx) {
                this.config.dns.pools.splice(idx, 1)
            },
            getFirstPoolStrategy() {
                return this.config.dns.pools[0]?.strategy || 'parallel'
            },
            setFirstPoolStrategy(s) {
                if (this.config.dns.pools.length > 0) {
                    this.config.dns.pools[0].strategy = s
                } else {
                    this.addPool();
                    this.config.dns.pools[0].strategy = s
                }
            },
            async saveConfig() {
                try {
                    const res = await fetch('/api/config', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.config)
                    });
                    if (res.ok) {
                        this.showAlert('success', 'Configuration saved successfully!')
                    } else {
                        const err = await res.text();
                        this.showAlert('error', 'Failed to save: ' + err)
                    }
                } catch (e) {
                    this.showAlert('error', 'Failed to save: ' + e.message)
                }
            },
            async saveDnsSettings() {
                try {
                    const r = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.settings)
                    });
                    if (r.ok) {
                        const data = await r.json();
                        this.showAlert('success', 'DNS settings saved!');
                        if (data.message.includes('restart')) {
                            this.restartRequired = true
                        }
                    } else {
                        const error = await r.json();
                        this.showAlert('error', 'Failed: ' + (error.message || 'Unknown error'))
                    }
                } catch (e) {
                    console.error(e);
                    this.showAlert('error', 'Error: ' + e.message)
                }
            },
            toggleConditionalForwarding() {
                this.settings.conditional_forwarding_enabled = !this.settings.conditional_forwarding_enabled;
                if (!this.settings.conditional_forwarding_enabled) {
                    this.settings.local_domain = ''
                }
            },
            showAlert(type, msg) {
                this.alert = {show: true, type, message: msg};
                setTimeout(() => {
                    this.alert.show = false
                }, 5000)
            }
        }
    }
</script>
</body>
</html>
