<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Query Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        .card {
            padding: 16px
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 480px
        }

        @media (max-width: 1100px) {
            .col-rt { display: none }
        }

        @media (max-width: 820px) {
            .col-type { display: none }
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color)
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px
        }

        tr.row-allowed {
            background: rgba(16, 185, 129, 0.08)
        }

        tr.row-blocked {
            background: rgba(239, 68, 68, 0.08)
        }

        tr:hover {
            opacity: 0.85
        }

        .dnssec-icon {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: default;
        }

        .dnssec-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 7px);
            left: 50%;
            transform: translateX(-50%);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            font-family: monospace;
            letter-spacing: 0.05em;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            z-index: 10;
        }

        .dnssec-icon::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--border-color);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
        }

        .dnssec-icon:hover::after,
        .dnssec-icon:hover::before {
            opacity: 1;
        }

        .dnssec-icon[data-tooltip="SECURE"]::after    { color: #22C55E; }
        .dnssec-icon[data-tooltip="INSECURE"]::after  { color: #EAB308; }
        .dnssec-icon[data-tooltip="BOGUS"]::after     { color: #EF4444; }
    </style>
</head>
<body x-data="app()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span>
        </div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span></div>
        <div class="status-item"><i data-lucide="zap" style="width:14px;height:14px"></i><span
                x-text="stats.queries_total+' queries'">0 queries</span></div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item active"><i data-lucide="file-text" class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item"><i data-lucide="server" class="nav-icon"></i><span>Local DNS</span></a>
            <a href="/settings.html" class="nav-item"><i data-lucide="settings"
                                                         class="nav-icon"></i><span>Settings</span></a>
        </div>
    </nav>
</aside>
<main style="padding:24px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div>
            <h2 style="font-size:24px;font-weight:700;color:var(--text-primary)">Query Log</h2>
            <p style="font-size:14px;color:var(--text-secondary);margin-top:4px">DNS query history — last 24h</p>
        </div>
    </div>
    <div class="card" style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
                <label style="font-size:14px;font-weight:500;color:var(--text-secondary);white-space:nowrap">Show:</label>
                <select x-model.number="pageSize" @change="currentPage=1;_cursors={};loadQueries()"
                        style="padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);font-size:14px">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
                <label style="font-size:14px;font-weight:500;color:var(--text-secondary);white-space:nowrap">Category:</label>
                <select x-model="category" @change="currentPage=1"
                        style="padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);font-size:14px">
                    <option value="">All Queries</option>
                    <option value="allowed">Allowed</option>
                    <option value="blocked">Blocked</option>
                    <option value="cache">Cache Hits</option>
                    <option value="upstream">Upstream</option>
                </select>
            </div>
            <div style="margin-left:auto">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" x-model="autoRefresh"
                           style="width:16px;height:16px;accent-color:var(--color-primary)">
                    <span style="font-size:14px;color:var(--text-secondary)">Live update</span>
                </label>
            </div>
        </div>
    </div>
    <div class="card" style="overflow-x:auto">
        <table>
            <thead>
            <tr>
                <th style="width:130px">TIME</th>
                <th>DOMAIN</th>
                <th class="col-type" style="width:75px">TYPE</th>
                <th style="width:140px">CLIENT</th>
                <th style="width:135px">SOURCE</th>
                <th class="col-rt" style="width:120px">RESPONSE TIME</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="query in paginatedQueries" :key="query.id||Math.random()">
                <tr :class="query.blocked ? 'row-blocked' : 'row-allowed'">
                    <td style="font-size:12px" x-text="formatTime(query.timestamp)"></td>
                    <td style="font-family:monospace;font-size:14px;max-width:0;overflow:hidden">
                        <div style="display:flex;align-items:center;gap:5px;overflow:hidden">
                            <template x-if="query.dnssec_status === 'Secure'">
                                <span class="dnssec-icon" data-tooltip="SECURE">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </span>
                            </template>
                            <template x-if="query.dnssec_status === 'Insecure'">
                                <span class="dnssec-icon" data-tooltip="INSECURE">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#EAB308" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </span>
                            </template>
                            <template x-if="query.dnssec_status === 'Bogus'">
                                <span class="dnssec-icon" data-tooltip="BOGUS">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </span>
                            </template>
                            <span x-text="query.domain" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" :title="query.domain"></span>
                        </div>
                    </td>
                    <td class="col-type"><span class="badge" style="background:rgba(59,130,246,0.1);color:#3B82F6"
                              x-text="query.type"></span></td>
                    <td style="font-size:13px"
                        x-text="query.client_hostname ? query.client_hostname + ' (' + query.client + ')' : query.client"></td>
                    <td>
                        <span class="badge"
                              :style="query.cache_hit
                                ? 'background:rgba(168,85,247,0.1);color:#A855F7'
                                : query.block_source === 'blocklist'
                                  ? 'background:rgba(239,68,68,0.1);color:#ef4444'
                                  : query.block_source === 'managed_domain'
                                    ? 'background:rgba(249,115,22,0.1);color:#f97316'
                                    : query.block_source === 'regex_filter'
                                      ? 'background:rgba(139,92,246,0.1);color:#8b5cf6'
                                      : query.response_status === 'LOCAL_DNS'
                                        ? 'background:rgba(34,197,94,0.1);color:#22C55E'
                                        : 'background:rgba(59,130,246,0.1);color:#3B82F6'"
                              x-text="query.cache_hit
                                ? 'Cache'
                                : query.block_source === 'blocklist'
                                  ? 'Blocklist'
                                  : query.block_source === 'managed_domain'
                                    ? 'Managed Domain'
                                    : query.block_source === 'regex_filter'
                                      ? 'Regex Filter'
                                      : query.response_status === 'LOCAL_DNS'
                                        ? 'Local DNS'
                                        : 'Upstream'"></span>
                    </td>
                    <td class="col-rt" style="font-size:13px" x-text="formatResponseTime(query)"></td>
                </tr>
            </template>
            </tbody>
        </table>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-top:16px;border-top:1px solid var(--border-color)">
            <div style="font-size:14px;color:var(--text-secondary)">
                Showing <span x-text="(currentPage-1)*pageSize+1"></span> to <span
                    x-text="Math.min(currentPage*pageSize,total)"></span> of <span
                    x-text="total"></span>
            </div>
            <div style="display:flex;gap:8px">
                <button @click="changePage(-1)" :disabled="currentPage===1"
                        style="padding:8px 16px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:14px"
                        :style="currentPage===1?'opacity:0.5;cursor:not-allowed':''">Previous
                </button>
                <button @click="changePage(1)" :disabled="currentPage>=totalPages"
                        style="padding:8px 16px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:14px"
                        :style="currentPage>=totalPages?'opacity:0.5;cursor:not-allowed':''">Next
                </button>
            </div>
        </div>
    </div>
</main>
<script>
    function app() {
        return {
            theme: 'light',
            queries: [],
            total: 0,
            pageSize: 25,
            currentPage: 1,
            category: '',
            autoRefresh: false,
            stats: {allowed: 0, blocked: 0, cacheHits: 0, upstream: 0, queries_total: 0},
            serverStats: null,
            _ctrl: {},
            _pollId: null,
            _cursors: {},

            async init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadQueries(), this.loadStats()]);
                scheduleLucide(100);
                this.startPolling();
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.stopPolling();
                    else this.startPolling();
                });
            },

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                scheduleLucide();
            },

            async loadQueries() {
                this._ctrl.queries?.abort();
                this._ctrl.queries = new AbortController();
                try {
                    const cursor = this._cursors[this.currentPage];
                    const pageParam = cursor
                        ? `cursor=${cursor}`
                        : `offset=${(this.currentPage - 1) * this.pageSize}`;
                    const res = await fetch(
                        `/api/queries?limit=${this.pageSize}&${pageParam}&period=24h`,
                        {signal: this._ctrl.queries.signal}
                    );
                    if (res.ok) {
                        const result = await res.json();
                        this.queries = result.data || result;
                        this.total = result.total ?? this.queries.length;
                        if (result.next_cursor != null) {
                            this._cursors[this.currentPage + 1] = result.next_cursor;
                        }
                        this.calculateStats();
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Error loading queries:', e);
                }
            },

            calculateStats() {
                if (this.serverStats) {
                    this.stats.blocked = this.serverStats.queries_blocked || 0;
                    this.stats.allowed = (this.serverStats.queries_total || 0) - this.stats.blocked;
                } else {
                    this.stats.allowed = this.queries.filter(q => !q.blocked).length;
                    this.stats.blocked = this.queries.filter(q => q.blocked).length;
                }
                this.stats.cacheHits = this.queries.filter(q => q.cache_hit).length;
                this.stats.upstream = this.queries.filter(q => !q.cache_hit && !q.blocked).length;
            },

            get filteredQueries() {
                let filtered = this.queries;
                if (this.category === 'allowed') filtered = filtered.filter(q => !q.blocked);
                if (this.category === 'blocked') filtered = filtered.filter(q => q.blocked);
                if (this.category === 'cache') filtered = filtered.filter(q => q.cache_hit);
                if (this.category === 'upstream') filtered = filtered.filter(q => !q.cache_hit && !q.blocked);
                return filtered;
            },

            get paginatedQueries() {
                return this.filteredQueries;
            },

            get totalPages() {
                return Math.max(1, Math.ceil(this.total / this.pageSize));
            },

            async changePage(delta) {
                const next = this.currentPage + delta;
                if (next < 1 || next > this.totalPages) return;
                this.currentPage = next;
                await this.loadQueries();
            },

            startPolling() {
                this.stopPolling();
                this._pollId = setInterval(() => {
                    if (this.autoRefresh) {
                        this.loadQueries();
                        this.loadStats();
                    }
                }, 5000);
            },

            stopPolling() {
                clearInterval(this._pollId);
                this._pollId = null;
            },

            async loadStats() {
                this._ctrl.stats?.abort();
                this._ctrl.stats = new AbortController();
                try {
                    const res = await fetch('/api/stats', {signal: this._ctrl.stats.signal});
                    if (res.ok) {
                        this.serverStats = await res.json();
                        this.stats.queries_total = this.serverStats.queries_total || 0;
                        this.calculateStats();
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Failed to load stats:', e);
                }
            },

            formatTime(timestamp) {
                if (!timestamp) return '-';
                return new Date(timestamp).toLocaleTimeString();
            },

            formatResponseTime(query) {
                const us = query.response_time_us;
                if (us == null) return '-';
                if (us < 1000) return `${Math.round(us)} µs`;
                if (us < 1000000) return `${Math.round(us / 1000)} ms`;
                return `${(us / 1000000).toFixed(2)} s`;
            }
        };
    }
</script>
</body>
</html>
