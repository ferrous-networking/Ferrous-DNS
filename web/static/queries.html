<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Ä Ferrous DNS - Query Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen" x-data="queryLog()" x-init="init()">

<header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="px-4 sm:px-6 lg:px-8 py-3 lg:py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 sm:space-x-3">
                <div class="text-2xl sm:text-3xl lg:text-4xl">ü¶Ä</div>
                <div>
                    <h1 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">Ferrous DNS</h1>
                    <p class="text-xs sm:text-sm text-gray-500 hidden sm:block">Query Log</p>
                </div>
            </div>

            <div class="flex gap-1 sm:gap-2">
                <a href="/" class="px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 bg-gray-600 text-white text-xs sm:text-sm rounded-lg hover:bg-gray-700">
                    <span class="hidden sm:inline">üìä Dashboard</span>
                    <span class="sm:hidden">üìä</span>
                </a>
                <a href="/queries.html" class="px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700">
                    <span class="hidden sm:inline">üìù Query Log</span>
                    <span class="sm:hidden">üìù</span>
                </a>
                <a href="/settings.html" class="px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 bg-gray-600 text-white text-xs sm:text-sm rounded-lg hover:bg-gray-700">
                    <span class="hidden sm:inline">‚öôÔ∏è Settings</span>
                    <span class="sm:hidden">‚öôÔ∏è</span>
                </a>
            </div>
        </div>
    </div>
</header>

<main class="flex-1 px-3 sm:px-4 lg:px-8 py-4 sm:py-6 lg:py-8 overflow-y-auto">

    <!-- Controls -->
    <div class="bg-white rounded-lg sm:rounded-xl shadow-sm p-3 sm:p-4 mb-4 sm:mb-6">
        <div class="flex flex-col gap-3">
            <!-- Top Row: Page Size + Auto-refresh -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-center sm:justify-between">
                <!-- Left: Page Size -->
                <div class="flex items-center gap-2">
                    <label class="text-xs sm:text-sm text-gray-700 font-medium">Show:</label>
                    <select x-model.number="pageSize" @change="currentPage = 1" 
                            class="text-xs sm:text-sm border border-gray-300 rounded-lg px-2 sm:px-3 py-1 sm:py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="text-xs sm:text-sm text-gray-600">queries</span>
                </div>

                <!-- Right: Auto-refresh -->
                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" x-model="autoRefresh" 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-xs sm:text-sm text-gray-700 font-medium">Auto-refresh (1s)</span>
                    </label>
                </div>
            </div>

            <!-- Bottom Row: DNSSEC Stats (only show if DNSSEC enabled) -->
            <div x-show="dnssecEnabled" class="flex flex-wrap gap-2 items-center border-t pt-3" x-cloak>
                <span class="text-xs sm:text-sm text-gray-600 font-medium">
                    üîê DNSSEC Enabled - Showing all queries including DNSSEC validations
                </span>
                
                <!-- Stats -->
                <span class="text-xs text-gray-500 ml-auto" x-show="queries.length > 0">
                    <span x-text="queries.length"></span> queries
                    <template x-if="dnssecCount > 0">
                        <span class="text-purple-600 font-medium">
                            (<span x-text="dnssecCount"></span> DNSSEC)
                        </span>
                    </template>
                </span>
            </div>

            <!-- Info message when DNSSEC disabled -->
            <div x-show="!dnssecEnabled && queries.length > 0" class="text-xs text-gray-500 border-t pt-3" x-cloak>
                üí° DNSSEC validation is disabled. Enable in Settings to see DNSSEC queries.
            </div>
        </div>
    </div>

    <!-- Desktop Table -->
    <div x-show="paginatedQueries.length > 0" class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden mb-6" x-cloak>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Domain</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Upstream</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Response</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="(query, index) in paginatedQueries" :key="index">
                    <tr class="hover:bg-gray-100" :class="query.blocked ? 'bg-red-50' : ''">
                        <!-- Time (FIRST) -->
                        <td class="px-4 py-3 text-sm text-gray-500" x-text="formatTimestamp(query.timestamp)"></td>
                        
                        <!-- Domain -->
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <!-- DNSSEC Status Icon (only if DNSSEC enabled and status exists) -->
                                <template x-if="dnssecEnabled && query.dnssec_status">
                                    <span 
                                        class="text-sm"
                                        :title="query.dnssec_status"
                                        x-text="query.dnssec_status === 'Secure' ? 'üîí' : 
                                                query.dnssec_status === 'Insecure' ? 'üîì' : 
                                                query.dnssec_status === 'Bogus' ? '‚ö†Ô∏è' : ''">
                                    </span>
                                </template>
                                <span class="font-medium text-gray-900 text-sm" x-text="query.domain"></span>
                            </div>
                        </td>
                        
                        <!-- Type -->
                        <td class="px-4 py-3">
                            <span 
                                class="px-2 py-0.5 rounded-full text-xs font-medium"
                                :class="isDnssec(query.type) ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'"
                                x-text="query.type">
                            </span>
                        </td>
                        
                        <!-- Client -->
                        <td class="px-4 py-3 text-sm text-gray-600" x-text="formatClientName(query.client)"></td>
                        
                        <!-- Source -->
                        <td class="px-4 py-3">
                            <span 
                                class="px-2 py-0.5 rounded-full text-xs font-medium"
                                :class="query.blocked ? 'bg-red-100 text-red-800' : (query.cache_refresh ? 'bg-yellow-100 text-yellow-800' : (query.cache_hit ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'))"
                                x-text="query.blocked ? 'üö´ Blocked' : (query.cache_refresh ? 'üîÑ Refresh' : (query.cache_hit ? '‚ö° Cache' : 'üåê Upstream'))">
                            </span>
                        </td>
                        
                        <!-- Upstream Server -->
                        <td class="px-4 py-3">
                            <span 
                                class="text-xs font-mono text-gray-700"
                                x-show="!query.cache_hit && query.upstream_server"
                                x-text="query.upstream_server">
                            </span>
                            <span 
                                class="text-xs text-gray-400"
                                x-show="query.cache_hit || !query.upstream_server">
                                -
                            </span>
                        </td>
                        
                        <!-- Response -->
                        <td class="px-4 py-3">
                            <span 
                                class="text-sm font-semibold"
                                :class="{
                                    'text-green-600': query.response_time_ms && query.response_time_ms < 1000,
                                    'text-yellow-600': query.response_time_ms >= 1000 && query.response_time_ms < 10000,
                                    'text-red-600': query.response_time_ms >= 10000,
                                    'text-gray-400': !query.response_time_ms
                                }"
                                x-text="formatResponseTime(query.response_time_ms)">
                            </span>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Mobile Cards -->
    <div x-show="paginatedQueries.length > 0" class="md:hidden space-y-3 mb-6" x-cloak>
        <template x-for="(query, index) in paginatedQueries" :key="index">
            <div class="bg-white rounded-lg shadow-sm p-4 border-l-4" :class="query.blocked ? 'border-red-500 bg-red-50' : 'border-green-500'">
                <!-- Header -->
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1 min-w-0 pr-2">
                        <div class="flex items-center gap-1">
                            <!-- DNSSEC Status Icon (only if DNSSEC enabled and status exists) -->
                            <template x-if="dnssecEnabled && query.dnssec_status">
                                <span 
                                    class="text-sm shrink-0"
                                    :title="query.dnssec_status"
                                    x-text="query.dnssec_status === 'Secure' ? 'üîí' : 
                                            query.dnssec_status === 'Insecure' ? 'üîì' : 
                                            query.dnssec_status === 'Bogus' ? '‚ö†Ô∏è' : ''">
                                </span>
                            </template>
                            <p class="font-semibold text-gray-900 truncate text-sm" x-text="query.domain"></p>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span 
                                class="px-2 py-0.5 rounded-full text-xs font-medium"
                                :class="isDnssec(query.type) ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'"
                                x-text="query.type">
                            </span>
                        </div>
                    </div>
                    <span 
                        class="px-2 py-0.5 rounded-full text-xs font-medium shrink-0"
                        :class="query.blocked ? 'bg-red-100 text-red-800' : (query.cache_refresh ? 'bg-yellow-100 text-yellow-800' : (query.cache_hit ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'))"
                        x-text="query.blocked ? 'üö´' : (query.cache_refresh ? 'üîÑ' : (query.cache_hit ? '‚ö°' : 'üåê'))">
                    </span>
                </div>
                
                <!-- Details -->
                <div class="space-y-1 text-xs text-gray-600">
                    <div class="flex justify-between">
                        <span>Client:</span>
                        <span class="font-medium" x-text="formatClientName(query.client)"></span>
                    </div>
                    <div class="flex justify-between" x-show="!query.cache_hit && query.upstream_server">
                        <span>Upstream:</span>
                        <span class="font-mono font-medium text-xs" x-text="query.upstream_server"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Time:</span>
                        <span class="font-medium text-xs" x-text="formatTimestamp(query.timestamp)"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Response:</span>
                        <span 
                            class="font-semibold"
                            :class="{
                                'text-green-600': query.response_time_ms && query.response_time_ms < 1000,
                                'text-yellow-600': query.response_time_ms >= 1000 && query.response_time_ms < 10000,
                                'text-red-600': query.response_time_ms >= 10000,
                                'text-gray-400': !query.response_time_ms
                            }"
                            x-text="formatResponseTime(query.response_time_ms)">
                        </span>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="queries.length === 0" class="text-center py-12 text-gray-500">
        <p class="text-lg mb-2">No queries yet</p>
        <p class="text-sm">Make a DNS query to see it here!</p>
    </div>

    <!-- Pagination -->
    <div x-show="totalPages > 1" class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-white rounded-lg sm:rounded-xl shadow-sm p-3 sm:p-4" x-cloak>
        <div class="text-xs sm:text-sm text-gray-700">
            Showing <span class="font-semibold" x-text="startIndex + 1"></span> to 
            <span class="font-semibold" x-text="Math.min(endIndex, queries.length)"></span> of 
            <span class="font-semibold" x-text="queries.length"></span> queries
        </div>
        
        <div class="flex gap-2">
            <button @click="currentPage = Math.max(1, currentPage - 1)" :disabled="currentPage === 1" 
                    class="px-3 py-1.5 text-xs sm:text-sm bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700">
                Previous
            </button>
            <span class="px-3 py-1.5 text-xs sm:text-sm bg-gray-100 rounded-lg font-medium">
                Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
            </span>
            <button @click="currentPage = Math.min(totalPages, currentPage + 1)" :disabled="currentPage === totalPages"
                    class="px-3 py-1.5 text-xs sm:text-sm bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700">
                Next
            </button>
        </div>
    </div>

</main>

<script>
function queryLog() {
    return {
        queries: [],
        pageSize: 25,
        currentPage: 1,
        autoRefresh: true,
        showDnssec: false,  // Filter toggle
        dnssecEnabled: false,  // From config
        serverHostname: 'localhost',  // Server hostname for internal queries

        // DNSSEC record types
        dnssecTypes: ['DS', 'DNSKEY', 'RRSIG', 'NSEC', 'NSEC3', 'NSEC3PARAM', 'CDS', 'CDNSKEY'],

        get filteredQueries() {
            // ‚úÖ ALWAYS show all queries when DNSSEC is enabled
            if (this.dnssecEnabled) {
                return this.queries;
            }
            // When DNSSEC disabled, also show all queries
            return this.queries;
        },
        get dnssecCount() {
            return this.queries.filter(q => this.dnssecTypes.includes(q.type)).length;
        },
        get totalPages() {
            return Math.ceil(this.filteredQueries.length / this.pageSize);
        },
        get startIndex() {
            return (this.currentPage - 1) * this.pageSize;
        },
        get endIndex() {
            return this.startIndex + this.pageSize;
        },
        get paginatedQueries() {
            return this.filteredQueries.slice(this.startIndex, this.endIndex);
        },

        async init() {
            await this.loadConfig();
            await this.loadHostname();
            await this.loadQueries();
            setInterval(() => {
                if (this.autoRefresh) this.loadQueries();
            }, 1000);
        },

        async loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                this.dnssecEnabled = config.dns.dnssec_enabled;
                console.log('DNSSEC enabled:', this.dnssecEnabled);
            } catch (error) {
                console.error('Error loading config:', error);
            }
        },

        async loadHostname() {
            try {
                const res = await fetch('/api/hostname');
                const data = await res.json();
                this.serverHostname = data.hostname;
                console.log('Server hostname:', this.serverHostname);
            } catch (error) {
                console.error('Error loading hostname:', error);
            }
        },

        async loadQueries() {
            try {
                const res = await fetch('/api/queries');
                this.queries = await res.json();
            } catch (error) {
                console.error('Error loading queries:', error);
                this.queries = [];
            }
        },

        isDnssec(type) {
            return this.dnssecTypes.includes(type);
        },

        formatClientName(ip) {
            if (ip.startsWith('127.') || ip === '::1') {
                return this.serverHostname;  // Show server hostname for internal queries
            }
            if (ip.startsWith('192.168.')) return 'Local';
            return ip;
        },

        formatResponseTime(us) {
            if (!us) return '-';
            
            // Backend SEMPRE retorna em MICROSSEGUNDOS (¬µs)
            // Exemplos:
            //   50 ¬µs = cache hit
            //   15,000 ¬µs = 15 ms upstream
            //   3,000,000 ¬µs = 3 s slow
            
            if (us < 1000) {
                // < 1ms = mostrar em ¬µs
                return `${Math.round(us)} ¬µs`;
            } else if (us < 1000000) {
                // 1ms - 999ms = converter para ms
                return `${Math.round(us / 1000)} ms`;
            } else {
                // >= 1s = converter para segundos
                return `${(us / 1000000).toFixed(2)} s`;
            }
        },

        formatTimestamp(utcTimestamp) {
            if (!utcTimestamp) return '-';
            
            try {
                // Parse UTC timestamp from backend (format: "2026-02-03 14:30:45")
                const date = new Date(utcTimestamp + ' UTC');
                
                // Get browser timezone
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Format to local time with timezone
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                
                const dateOptions = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                };
                
                const timeStr = date.toLocaleTimeString('en-US', timeOptions);
                const dateStr = date.toLocaleDateString('en-CA'); // yyyy-mm-dd
                
                // Short timezone abbreviation
                const tzShort = date.toLocaleTimeString('en-US', { timeZoneName: 'short' }).split(' ').pop();
                
                return `${dateStr} ${timeStr} ${tzShort}`;
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return utcTimestamp;
            }
        }
    }
}
</script>
</body>
</html>
