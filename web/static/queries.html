<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Query Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        .card {
            padding: 16px
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color)
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px
        }

        tr.row-allowed {
            background: rgba(16, 185, 129, 0.08)
        }

        tr.row-blocked {
            background: rgba(239, 68, 68, 0.08)
        }

        tr:hover {
            opacity: 0.85
        }
    </style>
</head>
<body x-data="app()" x-init="init()">
<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text"><h1>Ferrous DNS</h1><span class="logo-subtitle">High-Performance DNS</span></div>
    </div>
    <div class="status-box">
        <div class="status-header"><i data-lucide="activity" style="width:16px;height:16px"></i><span>Status</span>
        </div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span></div>
        <div class="status-item"><i data-lucide="zap" style="width:14px;height:14px"></i><span
                x-text="stats.queries_total+' queries'">0 queries</span></div>
    </div>
    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item"><i data-lucide="layout-dashboard" class="nav-icon"></i><span>Dashboard</span></a>
            <a href="/queries.html" class="nav-item active"><i data-lucide="file-text" class="nav-icon"></i><span>Query Log</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item"><i data-lucide="server" class="nav-icon"></i><span>Local DNS</span></a>
            <a href="/settings.html" class="nav-item"><i data-lucide="settings"
                                                         class="nav-icon"></i><span>Settings</span></a>
        </div>
    </nav>
    <div class="sidebar-footer">
        <button @click="toggleTheme()" class="theme-btn">
            <i data-lucide="sun" x-show="theme==='light'" style="width:16px;height:16px"></i>
            <i data-lucide="moon" x-show="theme==='dark'" style="width:16px;height:16px"></i>
            <span>Theme</span>
        </button>
    </div>
</aside>
<main style="padding:24px">
    <div class="card" style="margin-bottom:24px">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;align-items:center">
            <div>
                <label style="font-size:14px;font-weight:500;color:var(--text-secondary);margin-bottom:8px;display:block">Show:</label>
                <select x-model.number="pageSize" @change="currentPage=1;loadQueries()"
                        style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary)">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div>
                <label style="font-size:14px;font-weight:500;color:var(--text-secondary);margin-bottom:8px;display:block">Category:</label>
                <select x-model="category" @change="currentPage=1"
                        style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary)">
                    <option value="">All Queries</option>
                    <option value="allowed">Allowed</option>
                    <option value="blocked">Blocked</option>
                    <option value="cache">Cache Hits</option>
                    <option value="upstream">Upstream</option>
                </select>
            </div>
            <div>
                <label style="font-size:14px;font-weight:500;color:var(--text-secondary);margin-bottom:8px;display:block">&nbsp;</label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" x-model="autoRefresh"
                           style="width:16px;height:16px;accent-color:var(--color-primary)">
                    <span style="font-size:14px;color:var(--text-secondary)">Auto-refresh (1s)</span>
                </label>
            </div>
        </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
        <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
                <i data-lucide="check-circle" style="width:32px;height:32px;color:var(--color-success)"></i>
                <div><p style="font-size:12px;color:var(--text-secondary)">Allowed</p>
                    <p style="font-size:24px;font-weight:700;color:var(--text-primary)" x-text="stats.allowed">0</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
                <i data-lucide="shield-ban" style="width:32px;height:32px;color:var(--color-error)"></i>
                <div><p style="font-size:12px;color:var(--text-secondary)">Blocked</p>
                    <p style="font-size:24px;font-weight:700;color:var(--text-primary)" x-text="stats.blocked">0</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
                <i data-lucide="zap" style="width:32px;height:32px;color:#A855F7"></i>
                <div><p style="font-size:12px;color:var(--text-secondary)">Cache Hits</p>
                    <p style="font-size:24px;font-weight:700;color:var(--text-primary)" x-text="stats.cacheHits">0</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
                <i data-lucide="server" style="width:32px;height:32px;color:var(--color-info)"></i>
                <div><p style="font-size:12px;color:var(--text-secondary)">Upstream</p>
                    <p style="font-size:24px;font-weight:700;color:var(--text-primary)" x-text="stats.upstream">0</p>
                </div>
            </div>
        </div>
    </div>
    <div class="card" style="overflow-x:auto">
        <table>
            <thead>
            <tr>
                <th>TIME</th>
                <th>DOMAIN</th>
                <th>TYPE</th>
                <th>CLIENT</th>
                <th>SOURCE</th>
                <th>RESPONSE TIME</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="query in paginatedQueries" :key="query.id||Math.random()">
                <tr :class="query.blocked ? 'row-blocked' : 'row-allowed'">
                    <td style="font-size:12px" x-text="formatTime(query.timestamp)"></td>
                    <td style="font-family:monospace;font-size:14px" x-text="query.domain"></td>
                    <td><span class="badge" style="background:rgba(59,130,246,0.1);color:#3B82F6"
                              x-text="query.type"></span></td>
                    <td style="font-size:13px" x-text="query.client"></td>
                    <td>
                        <span class="badge"
                              :style="query.cache_hit
                                ? 'background:rgba(168,85,247,0.1);color:#A855F7'
                                : query.block_source === 'blocklist'
                                  ? 'background:rgba(239,68,68,0.1);color:#ef4444'
                                  : query.block_source === 'managed_domain'
                                    ? 'background:rgba(249,115,22,0.1);color:#f97316'
                                    : query.block_source === 'regex_filter'
                                      ? 'background:rgba(139,92,246,0.1);color:#8b5cf6'
                                      : 'background:rgba(59,130,246,0.1);color:#3B82F6'"
                              x-text="query.cache_hit
                                ? 'Cache'
                                : query.block_source === 'blocklist'
                                  ? 'Blocklist'
                                  : query.block_source === 'managed_domain'
                                    ? 'Managed Domain'
                                    : query.block_source === 'regex_filter'
                                      ? 'Regex Filter'
                                      : 'Upstream'"></span>
                    </td>
                    <td style="font-size:13px" x-text="formatResponseTime(query)"></td>
                </tr>
            </template>
            </tbody>
        </table>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-top:16px;border-top:1px solid var(--border-color)">
            <div style="font-size:14px;color:var(--text-secondary)">
                Showing <span x-text="(currentPage-1)*pageSize+1"></span> to <span
                    x-text="Math.min(currentPage*pageSize,total)"></span> of <span
                    x-text="total"></span>
            </div>
            <div style="display:flex;gap:8px">
                <button @click="changePage(-1)" :disabled="currentPage===1"
                        style="padding:8px 16px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:14px"
                        :style="currentPage===1?'opacity:0.5;cursor:not-allowed':''">Previous
                </button>
                <button @click="changePage(1)" :disabled="currentPage>=totalPages"
                        style="padding:8px 16px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:14px"
                        :style="currentPage>=totalPages?'opacity:0.5;cursor:not-allowed':''">Next
                </button>
            </div>
        </div>
    </div>
</main>
<script>
    function app() {
        return {
            theme: 'light',
            queries: [],
            total: 0,
            pageSize: 50,
            currentPage: 1,
            category: '',
            autoRefresh: true,
            stats: {allowed: 0, blocked: 0, cacheHits: 0, upstream: 0, queries_total: 0},
            serverStats: null,
            _ctrl: {},
            _pollId: null,

            async init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await Promise.all([this.loadQueries(), this.loadStats()]);
                scheduleLucide(100);
                this.startPolling();
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.stopPolling();
                    else this.startPolling();
                });
            },

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                scheduleLucide();
            },

            async loadQueries() {
                this._ctrl.queries?.abort();
                this._ctrl.queries = new AbortController();
                try {
                    const offset = (this.currentPage - 1) * this.pageSize;
                    const res = await fetch(
                        `/api/queries?limit=${this.pageSize}&offset=${offset}&period=24h`,
                        {signal: this._ctrl.queries.signal}
                    );
                    if (res.ok) {
                        const result = await res.json();
                        this.queries = result.data || result;
                        this.total = result.total ?? this.queries.length;
                        this.calculateStats();
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Error loading queries:', e);
                }
            },

            calculateStats() {
                if (this.serverStats) {
                    this.stats.blocked = this.serverStats.queries_blocked || 0;
                    this.stats.allowed = (this.serverStats.queries_total || 0) - this.stats.blocked;
                } else {
                    this.stats.allowed = this.queries.filter(q => !q.blocked).length;
                    this.stats.blocked = this.queries.filter(q => q.blocked).length;
                }
                this.stats.cacheHits = this.queries.filter(q => q.cache_hit).length;
                this.stats.upstream = this.queries.filter(q => !q.cache_hit && !q.blocked).length;
            },

            get filteredQueries() {
                let filtered = this.queries;
                if (this.category === 'allowed') filtered = filtered.filter(q => !q.blocked);
                if (this.category === 'blocked') filtered = filtered.filter(q => q.blocked);
                if (this.category === 'cache') filtered = filtered.filter(q => q.cache_hit);
                if (this.category === 'upstream') filtered = filtered.filter(q => !q.cache_hit && !q.blocked);
                return filtered;
            },

            get paginatedQueries() {
                return this.filteredQueries;
            },

            get totalPages() {
                return Math.max(1, Math.ceil(this.total / this.pageSize));
            },

            async changePage(delta) {
                const next = this.currentPage + delta;
                if (next < 1 || next > this.totalPages) return;
                this.currentPage = next;
                await this.loadQueries();
            },

            startPolling() {
                this.stopPolling();
                this._pollId = setInterval(() => {
                    if (this.autoRefresh) {
                        this.loadQueries();
                        this.loadStats();
                    }
                }, 5000);
            },

            stopPolling() {
                clearInterval(this._pollId);
                this._pollId = null;
            },

            async loadStats() {
                this._ctrl.stats?.abort();
                this._ctrl.stats = new AbortController();
                try {
                    const res = await fetch('/api/stats', {signal: this._ctrl.stats.signal});
                    if (res.ok) {
                        this.serverStats = await res.json();
                        this.stats.queries_total = this.serverStats.queries_total || 0;
                        this.calculateStats();
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') console.error('Failed to load stats:', e);
                }
            },

            formatTime(timestamp) {
                if (!timestamp) return '-';
                return new Date(timestamp).toLocaleTimeString();
            },

            formatResponseTime(query) {
                const us = query.response_time_ms || 0;
                if (!us) return '-';
                if (us < 1000) return `${Math.round(us)} Âµs`;
                if (us < 1000000) return `${Math.round(us / 1000)} ms`;
                return `${(us / 1000000).toFixed(2)} s`;
            }
        };
    }
</script>
</body>
</html>
