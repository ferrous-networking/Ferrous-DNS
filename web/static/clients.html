<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Network Clients</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        let _lucideTimer = null;
        function scheduleLucide(delay = 50) {
            clearTimeout(_lucideTimer);
            _lucideTimer = setTimeout(() => lucide.createIcons(), delay);
        }
    </script>
    <link rel="stylesheet" href="/static/shared.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif
        }

        .card {
            padding: 24px;
            margin-bottom: 24px
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            border: none
        }

        .btn-primary:hover { opacity: 0.9 }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed }

        .btn-icon {
            padding: 6px;
            border-radius: 6px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover { background: var(--bg-tertiary); }
        .btn-icon.edit:hover { color: var(--color-primary); }
        .btn-icon.delete:hover { color: var(--color-error); }
        .btn-icon.save:hover { color: var(--color-success); }
        .btn-icon.cancel:hover { color: var(--text-secondary); }
        .btn-icon:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-bulk-delete {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-bulk-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .input, .select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px
        }

        .input-inline {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--color-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            width: 140px;
        }

        .select-inline {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--color-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
        }

        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color)
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color)
        }

        .table tbody tr:hover { background: var(--bg-tertiary) }
        .table tbody tr.editing { background: rgba(59,130,246,0.05); }

        .monospace { font-family: monospace }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 16px
        }

        .badge-ip { background: rgba(59, 130, 246, 0.15); color: #3b82f6 }
        .badge-subnet { background: rgba(16, 185, 129, 0.15); color: #10b981 }
        .badge-mac { background: rgba(249, 115, 22, 0.15); color: #f97316 }

        .logo-text h1 { font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0 }
        .logo-subtitle { font-size: 11px; color: var(--text-tertiary) }

        .status-box { margin: 0 16px 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px }
        .status-header {
            display: flex; align-items: center; gap: 8px;
            font-size: 11px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 8px; text-transform: uppercase
        }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--color-success) }

        .nav-section { margin-bottom: 24px }
        .nav-section-title { padding: 8px 16px; font-size: 10px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--text-secondary); text-decoration: none; font-size: 14px; transition: all .2s }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary) }
        .nav-item.active { background: var(--bg-tertiary); color: var(--color-primary); font-weight: 600; border-left: 3px solid var(--color-primary) }
        .nav-icon { width: 18px; height: 18px }

        .logo-container { display: flex; align-items: center; gap: 12px; padding: 24px 16px 16px }
        .logo-icon { width: 40px; height: 40px; padding: 8px; background: var(--color-primary); color: white; border-radius: 8px }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
    </style>
</head>

<body x-data="app()" x-init="init()">

<aside class="sidebar">
    <div class="logo-container">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div class="logo-text">
            <h1>Ferrous DNS</h1>
            <span class="logo-subtitle">High-Performance DNS</span>
        </div>
    </div>

    <div class="status-box">
        <div class="status-header">
            <i data-lucide="activity" style="width:16px;height:16px"></i>
            <span>Status</span>
        </div>
        <div class="status-item">
            <div class="status-indicator"></div>
            <span>Active</span>
        </div>
        <div class="status-item">
            <i data-lucide="users" style="width:14px;height:14px"></i>
            <span x-text="(stats.total_clients || 0) + ' clients'">0 clients</span>
        </div>
    </div>

    <nav style="flex:1;padding:16px 0">
        <div class="nav-section">
            <div class="nav-section-title">MAIN</div>
            <a href="/dashboard.html" class="nav-item">
                <i data-lucide="layout-dashboard" class="nav-icon"></i>
                <span>Dashboard</span>
            </a>
            <a href="/queries.html" class="nav-item">
                <i data-lucide="file-text" class="nav-icon"></i>
                <span>Query Log</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">NETWORK MANAGEMENT</div>
            <a href="/clients.html" class="nav-item active">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Clients</span>
            </a>
            <a href="/groups.html" class="nav-item">
                <i data-lucide="layers" class="nav-icon"></i>
                <span>Groups</span>
            </a>
            <a href="/dns-filter.html" class="nav-item">
                <i data-lucide="shield" class="nav-icon"></i>
                <span>DNS Filter</span>
            </a>
            <a href="/block-services.html" class="nav-item">
                <i data-lucide="shield-ban" class="nav-icon"></i>
                <span>Block Services</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">DNS CONTROL</div>
            <a href="/local-dns-settings.html" class="nav-item">
                <i data-lucide="server" class="nav-icon"></i>
                <span>Local DNS</span>
            </a>
            <a href="/settings.html" class="nav-item">
                <i data-lucide="settings" class="nav-icon"></i>
                <span>Settings</span>
            </a>
        </div>
    </nav>

</aside>

<main style="padding:32px">

    <div style="margin-bottom:32px">
        <h1 style="font-size:28px;font-weight:700;margin-bottom:8px">ðŸ‘¥ Network Clients</h1>
        <p style="font-size:14px;color:var(--text-secondary)">Manage DNS clients by IP, subnet or MAC address</p>
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px">
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Total Clients</p>
            <p style="font-size:32px;font-weight:700" x-text="stats.total_clients || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Active 24h</p>
            <p style="font-size:32px;font-weight:700;color:var(--color-success)" x-text="stats.active_24h || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Active 7d</p>
            <p style="font-size:32px;font-weight:700;color:var(--color-warning)" x-text="stats.active_7d || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">With Hostname</p>
            <p style="font-size:32px;font-weight:700;color:#8B5CF6" x-text="stats.with_hostname || 0"></p>
        </div>
    </div>

    <!-- Add Client / Subnet form -->
    <div class="card">
        <h2 style="font-size:20px;font-weight:700;margin-bottom:16px">Add Client or Subnet</h2>

        <div x-show="form.type" class="badge" :class="getBadgeClass()">
            <i data-lucide="circle" style="width:16px;height:16px"></i>
            <span x-text="getTypeLabel()"></span>
        </div>

        <form @submit.prevent="submitForm()" style="display:flex;flex-direction:column;gap:16px">
            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px">
                    Address / Network *
                </label>
                <input x-model="form.address"
                       @input="detectType()"
                       type="text"
                       placeholder="IP (192.168.1.100), CIDR (192.168.1.0/24) or MAC (aa:bb:cc:dd:ee:ff)"
                       required
                       class="input">
                <p x-show="form.error" x-text="form.error"
                   style="margin-top:6px;font-size:12px;color:var(--color-error)"></p>
            </div>

            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px">
                    Group <span x-show="form.type==='subnet'" style="color:var(--color-error)">*</span>
                </label>
                <select x-model="form.group_id" class="select">
                    <template x-for="g in groups" :key="g.id">
                        <option :value="g.id" x-text="g.name"></option>
                    </template>
                </select>
            </div>

            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px"
                       x-text="form.type==='subnet' ? 'Comment' : 'Hostname'">Hostname</label>
                <input x-model="form.metadata"
                       type="text"
                       :placeholder="form.type==='subnet' ? 'Office network' : 'device-name'"
                       class="input">
            </div>

            <button type="submit" :disabled="!form.type || form.type==='mac'" class="btn btn-primary">
                <span x-text="getButtonText()">Submit</span>
            </button>
        </form>
    </div>

    <!-- Known Clients -->
    <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <h2 style="font-size:20px;font-weight:700">
                Known Clients (<span x-text="clients.length">0</span>)
            </h2>
        </div>

        <div x-show="clients.length === 0" style="padding:32px;text-align:center;color:var(--text-secondary)">
            No clients discovered yet
        </div>

        <table x-show="clients.length > 0" class="table">
            <thead>
            <tr>
                <th>IP Address</th>
                <th>Hostname</th>
                <th>MAC Address</th>
                <th>Group</th>
                <th>First Seen</th>
                <th>Last Seen</th>
                <th>Queries</th>
                <th style="text-align:center;width:90px">Actions</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="c in clients" :key="c.id">
                <tr :class="{'editing': editingId === c.id}">
                    <td class="monospace" x-text="c.ip_address"></td>

                    <!-- Hostname: display or edit -->
                    <td>
                        <template x-if="editingId !== c.id">
                            <span x-text="c.hostname || '-'"></span>
                        </template>
                        <template x-if="editingId === c.id">
                            <input class="input-inline" x-model="editForm.hostname" placeholder="hostname">
                        </template>
                    </td>

                    <td class="monospace" x-text="c.mac_address || '-'"></td>

                    <!-- Group: display or edit -->
                    <td>
                        <template x-if="editingId !== c.id">
                            <span x-text="getGroupName(c.group_id)"></span>
                        </template>
                        <template x-if="editingId === c.id">
                            <select class="select-inline" x-model="editForm.group_id">
                                <template x-for="g in groups" :key="g.id">
                                    <option :value="g.id" x-text="g.name"></option>
                                </template>
                            </select>
                        </template>
                    </td>

                    <td x-text="formatDateTime(c.first_seen)"></td>
                    <td x-text="formatDateTime(c.last_seen)"></td>
                    <td x-text="c.query_count || 0"></td>

                    <td style="text-align:center;width:90px;white-space:nowrap">
                        <!-- Normal mode: edit + delete -->
                        <template x-if="editingId !== c.id">
                            <span>
                                <button @click="startEdit(c)" class="btn-icon edit" title="Edit">
                                    <i data-lucide="pencil" style="width:15px;height:15px"></i>
                                </button>
                                <button @click="deleteClient(c.id)" class="btn-icon delete" title="Delete">
                                    <i data-lucide="trash-2" style="width:15px;height:15px"></i>
                                </button>
                            </span>
                        </template>
                        <!-- Edit mode: save + cancel -->
                        <template x-if="editingId === c.id">
                            <span>
                                <button @click="saveEdit(c.id)" class="btn-icon save" title="Save">
                                    <i data-lucide="check" style="width:15px;height:15px"></i>
                                </button>
                                <button @click="cancelEdit()" class="btn-icon cancel" title="Cancel">
                                    <i data-lucide="x" style="width:15px;height:15px"></i>
                                </button>
                            </span>
                        </template>
                    </td>
                </tr>
            </template>
            </tbody>
        </table>
    </div>

    <!-- Subnets -->
    <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <h2 style="font-size:20px;font-weight:700">
                Subnets (<span x-text="subnets.length">0</span>)
            </h2>
            <div x-show="selectedSubnets.length > 0">
                <button @click="bulkDeleteSubnets()" class="btn-bulk-delete">
                    <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                    <span x-text="`Delete ${selectedSubnets.length} item${selectedSubnets.length > 1 ? 's' : ''}`"></span>
                </button>
            </div>
        </div>

        <div x-show="subnets.length === 0" style="padding:32px;text-align:center;color:var(--text-secondary)">
            No subnets configured yet
        </div>

        <table x-show="subnets.length > 0" class="table">
            <thead>
            <tr>
                <th style="width:40px;text-align:center">
                    <input type="checkbox"
                           x-model="selectAllSubnets"
                           @change="toggleSelectAllSubnets()"
                           title="Select All">
                </th>
                <th>Subnet CIDR</th>
                <th>Group</th>
                <th>Comment</th>
                <th style="text-align:center;width:80px">Actions</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="s in subnets" :key="s.id">
                <tr>
                    <td style="width:40px;text-align:center">
                        <input type="checkbox"
                               :value="s.id"
                               x-model="selectedSubnets"
                               @change="updateSelectAllSubnets()">
                    </td>
                    <td class="monospace" x-text="s.subnet_cidr"></td>
                    <td x-text="getGroupName(s.group_id)"></td>
                    <td x-text="s.comment || '-'"></td>
                    <td style="text-align:center;width:80px">
                        <button @click="deleteSubnet(s.id)" class="btn-icon delete" title="Delete">
                            <i data-lucide="trash-2" style="width:16px;height:16px"></i>
                        </button>
                    </td>
                </tr>
            </template>
            </tbody>
        </table>
    </div>

</main>

<script>
    function app() {
        return {
            clients: [],
            groups: [],
            subnets: [],
            stats: {},
            selectedSubnets: [],
            selectAllSubnets: false,
            editingId: null,
            editForm: { hostname: '', group_id: '' },
            form: {
                address: '',
                group_id: '',
                metadata: '',
                type: null,
                error: ''
            },

            async init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                await this.loadAll();
                scheduleLucide(100);
            },

            async loadAll() {
                await Promise.all([
                    this.loadClients(),
                    this.loadGroups(),
                    this.loadStats(),
                    this.loadSubnets(),
                ]);
            },

            async loadClients() {
                try {
                    const res = await fetch('/api/clients?limit=1000');
                    if (res.ok) this.clients = await res.json();
                } catch (e) {
                    console.error('Failed to load clients:', e);
                }
            },

            async loadGroups() {
                try {
                    const res = await fetch('/api/groups');
                    if (res.ok) {
                        this.groups = await res.json();
                        const defaultGroup = this.groups.find(g => g.name === 'Protected') || this.groups[0];
                        if (defaultGroup && !this.form.group_id) this.form.group_id = defaultGroup.id;
                    }
                } catch (e) {
                    console.error('Failed to load groups:', e);
                }
            },

            async loadStats() {
                try {
                    const res = await fetch('/api/clients/stats');
                    if (res.ok) this.stats = await res.json();
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            },

            async loadSubnets() {
                try {
                    const res = await fetch('/api/client-subnets');
                    if (res.ok) this.subnets = await res.json();
                } catch (e) {
                    console.error('Failed to load subnets:', e);
                }
            },

            getGroupName(id) {
                const g = this.groups.find(x => x.id === id);
                return g ? g.name : '-';
            },

            startEdit(c) {
                this.editingId = c.id;
                const defaultGroup = this.groups.find(g => g.name === 'Protected') || this.groups[0];
                this.editForm = {
                    hostname: c.hostname || '',
                    group_id: c.group_id ? String(c.group_id) : (defaultGroup ? String(defaultGroup.id) : ''),
                };
                this.$nextTick(() => scheduleLucide(50));
            },

            cancelEdit() {
                this.editingId = null;
                this.editForm = { hostname: '', group_id: '' };
                scheduleLucide(50);
            },

            async saveEdit(id) {
                const payload = {
                    hostname: this.editForm.hostname.trim() || null,
                    group_id: this.editForm.group_id ? parseInt(this.editForm.group_id) : null,
                };
                try {
                    const res = await fetch(`/api/clients/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (res.ok) {
                        const updated = await res.json();
                        const idx = this.clients.findIndex(c => c.id === id);
                        if (idx !== -1) this.clients[idx] = updated;
                        this.cancelEdit();
                        await this.loadStats();
                        scheduleLucide(50);
                    } else {
                        alert('Failed: ' + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error saving client');
                }
            },

            detectType() {
                const v = this.form.address.trim();
                this.form.error = '';
                if (!v) { this.form.type = null; return; }
                if (v.includes('/')) {
                    if (this.isValidCIDR(v)) { this.form.type = 'subnet'; }
                    else { this.form.type = null; this.form.error = 'Invalid CIDR format (e.g., 192.168.1.0/24)'; }
                    return;
                }
                if (this.isValidMAC(v)) {
                    this.form.type = 'mac';
                    this.form.error = 'MAC detected! Please enter the IP address.';
                    return;
                }
                if (this.isValidIP(v)) { this.form.type = 'ip'; }
                else { this.form.type = null; this.form.error = 'Invalid IP, CIDR or MAC address'; }
            },

            isValidIP(ip) {
                const parts = ip.split('.');
                if (parts.length === 4) {
                    return parts.every(p => {
                        const num = parseInt(p, 10);
                        return p === num.toString() && num >= 0 && num <= 255;
                    });
                }
                return false;
            },

            isValidCIDR(cidr) {
                const parts = cidr.split('/');
                if (parts.length !== 2) return false;
                const prefix = parseInt(parts[1]);
                if (!this.isValidIP(parts[0])) return false;
                return prefix >= 0 && prefix <= 32;
            },

            isValidMAC(mac) {
                return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$|^[0-9A-Fa-f]{12}$/.test(mac);
            },

            getBadgeClass() {
                if (this.form.type === 'ip') return 'badge-ip';
                if (this.form.type === 'subnet') return 'badge-subnet';
                if (this.form.type === 'mac') return 'badge-mac';
                return '';
            },

            getTypeLabel() {
                return { ip: 'IP Address â†’ Individual Client', subnet: 'CIDR Subnet â†’ Multiple Clients', mac: 'MAC Address â†’ Requires IP' }[this.form.type] || '';
            },

            getButtonText() {
                if (!this.form.type) return 'Enter address...';
                if (this.form.type === 'mac') return 'Add IP address';
                return this.form.type === 'subnet' ? 'Add Subnet' : 'Add Client';
            },

            async submitForm() {
                if (!this.form.type || this.form.type === 'mac' || this.form.error) {
                    alert(this.form.error || 'Invalid address');
                    return;
                }
                try {
                    if (this.form.type === 'subnet') { await this.submitSubnet(); }
                    else { await this.submitClient(); }
                } catch (e) {
                    console.error('Submission error:', e);
                    alert('Error: ' + e.message);
                }
            },

            async submitClient() {
                const res = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: this.form.address,
                        group_id: this.form.group_id ? parseInt(this.form.group_id) : null,
                        hostname: this.form.metadata || null,
                        mac_address: null
                    })
                });
                if (res.ok) { this.resetForm(); await this.loadAll(); scheduleLucide(); alert('Client added successfully!'); }
                else { alert('Failed: ' + await res.text()); }
            },

            async submitSubnet() {
                const res = await fetch('/api/client-subnets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subnet_cidr: this.form.address,
                        group_id: this.form.group_id ? parseInt(this.form.group_id) : null,
                        comment: this.form.metadata || null
                    })
                });
                if (res.ok) { this.resetForm(); await this.loadAll(); scheduleLucide(); alert('Subnet added successfully!'); }
                else { alert('Failed: ' + await res.text()); }
            },

            resetForm() {
                this.form = { address: '', group_id: '', metadata: '', type: null, error: '' };
            },

            async deleteClient(id) {
                if (!confirm('Delete this client?')) return;
                try {
                    const res = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
                    if (res.ok) { await this.loadAll(); scheduleLucide(); }
                    else { alert('Failed: ' + await res.text()); }
                } catch (e) {
                    console.error(e);
                    alert('Error deleting client');
                }
            },

            async deleteSubnet(id) {
                if (!confirm('Delete this subnet?')) return;
                try {
                    const res = await fetch(`/api/client-subnets/${id}`, { method: 'DELETE' });
                    if (res.ok) { await this.loadAll(); scheduleLucide(); }
                    else { alert('Failed: ' + await res.text()); }
                } catch (e) {
                    console.error(e);
                    alert('Error deleting subnet');
                }
            },

            toggleSelectAllSubnets() {
                this.selectedSubnets = this.selectAllSubnets ? this.subnets.map(s => s.id) : [];
            },

            updateSelectAllSubnets() {
                this.selectAllSubnets = this.selectedSubnets.length === this.subnets.length && this.subnets.length > 0;
            },

            async bulkDeleteSubnets() {
                const count = this.selectedSubnets.length;
                if (count === 0) return;
                if (!confirm(`Delete ${count} selected subnet${count > 1 ? 's' : ''}? This action cannot be undone.`)) return;
                try {
                    let deleted = 0, failed = 0;
                    for (let i = 0; i < this.selectedSubnets.length; i += 10) {
                        const batch = this.selectedSubnets.slice(i, i + 10);
                        await Promise.all(batch.map(id =>
                            fetch(`/api/client-subnets/${id}`, { method: 'DELETE' })
                                .then(res => res.ok ? deleted++ : failed++)
                                .catch(() => failed++)
                        ));
                    }
                    await this.loadAll();
                    scheduleLucide(100);
                    this.selectedSubnets = [];
                    this.selectAllSubnets = false;
                    if (failed === 0) alert(`${deleted} subnet${deleted > 1 ? 's' : ''} deleted successfully!`);
                    else alert(`Deleted ${deleted}. Failed to delete ${failed}.`);
                } catch (e) {
                    console.error('Bulk delete error:', e);
                    alert('Error during bulk delete operation');
                }
            },

            formatDateTime(timestamp) {
                if (!timestamp) return '-';
                return new Date(timestamp).toLocaleString();
            }
        }
    }
</script>

</body>
</html>
