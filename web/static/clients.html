<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrous DNS - Network Clients</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #3B82F6;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --bg-primary: #F9FAFB;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F4F6;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --border-color: #E5E7EB
        }

        .dark {
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-tertiary: #94A3B8;
            --border-color: #334155
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-left: 260px;
            margin: 0
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 24px
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            border: none
        }

        .btn-primary:hover {
            opacity: 0.9
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed
        }

        .input, .select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px
        }

        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color)
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color)
        }

        .table tbody tr:hover {
            background: var(--bg-tertiary)
        }

        .monospace {
            font-family: monospace
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 16px
        }

        .badge-ip {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6
        }

        .badge-subnet {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981
        }

        .badge-mac {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316
        }
    </style>
</head>

<body x-data="app()" x-init="init()">

<aside class="sidebar">
    <div style="margin-bottom:24px">
        <h1 style="font-size:20px;font-weight:700;margin-bottom:4px">Ferrous DNS</h1>
        <p style="font-size:11px;color:var(--text-tertiary)">Network Management</p>
    </div>

    <nav style="display:flex;flex-direction:column;gap:8px">
        <a href="dashboard.html" style="padding:10px 12px;border-radius:8px;color:var(--text-secondary);text-decoration:none">
            Dashboard
        </a>
        <a href="clients.html" style="padding:10px 12px;border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);text-decoration:none;font-weight:500">
            Clients
        </a>
        <a href="groups.html" style="padding:10px 12px;border-radius:8px;color:var(--text-secondary);text-decoration:none">
            Groups
        </a>
    </nav>

    <div style="margin-top:auto;padding-top:24px">
        <button @click="toggleTheme()" class="btn" style="width:100%;background:var(--bg-tertiary)">
            Toggle Theme
        </button>
    </div>
</aside>

<main style="padding:32px">

    <div style="margin-bottom:32px">
        <h1 style="font-size:28px;font-weight:700;margin-bottom:8px">ðŸ‘¥ Network Clients</h1>
        <p style="font-size:14px;color:var(--text-secondary)">Manage DNS clients by IP, subnet or MAC address</p>
    </div>

    <!-- STATS -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px">
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Total Clients</p>
            <p style="font-size:32px;font-weight:700" x-text="stats.total_clients || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Active 24h</p>
            <p style="font-size:32px;font-weight:700;color:var(--color-success)" x-text="stats.active_24h || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Active 7d</p>
            <p style="font-size:32px;font-weight:700;color:var(--color-warning)" x-text="stats.active_7d || 0"></p>
        </div>
        <div class="card" style="padding:20px">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">With Hostname</p>
            <p style="font-size:32px;font-weight:700;color:#8B5CF6" x-text="stats.with_hostname || 0"></p>
        </div>
    </div>

    <!-- ADD FORM -->
    <div class="card">
        <h2 style="font-size:20px;font-weight:700;margin-bottom:16px">Add Client or Subnet</h2>

        <!-- Type Badge -->
        <div x-show="form.type" class="badge" :class="getBadgeClass()">
            <i data-lucide="circle" style="width:16px;height:16px"></i>
            <span x-text="getTypeLabel()"></span>
        </div>

        <form @submit.prevent="submitForm()" style="display:flex;flex-direction:column;gap:16px">

            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px">
                    Address / Network *
                </label>
                <input x-model="form.address"
                       @input="detectType()"
                       type="text"
                       placeholder="IP (192.168.1.100), CIDR (192.168.1.0/24) or MAC (aa:bb:cc:dd:ee:ff)"
                       required
                       class="input">
                <p x-show="form.error" x-text="form.error" style="margin-top:6px;font-size:12px;color:var(--color-error)"></p>
            </div>

            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px">
                    Group <span x-show="form.type==='subnet'" style="color:var(--color-error)">*</span>
                </label>
                <select x-model="form.group_id" class="select">
                    <option value="">No Group</option>
                    <template x-for="g in groups" :key="g.id">
                        <option :value="g.id" x-text="g.name"></option>
                    </template>
                </select>
            </div>

            <div>
                <label style="display:block;font-size:14px;font-weight:500;margin-bottom:6px"
                       x-text="form.type==='subnet' ? 'Comment' : 'Hostname'">
                    Hostname
                </label>
                <input x-model="form.metadata"
                       type="text"
                       :placeholder="form.type==='subnet' ? 'Office network' : 'device-name'"
                       class="input">
            </div>

            <button type="submit"
                    :disabled="!form.type || form.type==='mac' || form.error"
                    class="btn btn-primary">
                <span x-text="getButtonText()">Submit</span>
            </button>
        </form>
    </div>

    <!-- CONFIGURED CLIENTS -->
    <div class="card">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px">Configured Clients</h3>

        <div x-show="manualClients.length === 0" style="padding:32px;text-align:center;color:var(--text-secondary)">
            No manual clients yet
        </div>

        <table x-show="manualClients.length > 0" class="table">
            <thead>
                <tr>
                    <th>IP Address</th>
                    <th>Hostname</th>
                    <th>MAC Address</th>
                    <th>Group</th>
                    <th>Added</th>
                    <th style="text-align:center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="c in manualClients" :key="c.id">
                    <tr>
                        <td class="monospace" x-text="c.ip_address"></td>
                        <td x-text="c.hostname || '-'"></td>
                        <td class="monospace" x-text="c.mac_address || '-'"></td>
                        <td x-text="getGroupName(c.group_id)"></td>
                        <td x-text="formatDateTime(c.first_seen)"></td>
                        <td style="text-align:center">
                            <button @click="deleteClient(c.id)" style="color:var(--color-error);background:none;border:none;cursor:pointer;padding:4px 8px">
                                Delete
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- CONFIGURED SUBNETS -->
    <div class="card">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px">Configured Subnets</h3>

        <div x-show="subnets.length === 0" style="padding:32px;text-align:center;color:var(--text-secondary)">
            No subnets configured yet
        </div>

        <table x-show="subnets.length > 0" class="table">
            <thead>
                <tr>
                    <th>Subnet CIDR</th>
                    <th>Group</th>
                    <th>Comment</th>
                    <th style="text-align:center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="s in subnets" :key="s.id">
                    <tr>
                        <td class="monospace" x-text="s.subnet_cidr"></td>
                        <td x-text="getGroupName(s.group_id)"></td>
                        <td x-text="s.comment || '-'"></td>
                        <td style="text-align:center">
                            <button @click="deleteSubnet(s.id)" style="color:var(--color-error);background:none;border:none;cursor:pointer;padding:4px 8px">
                                Delete
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

</main>

<script>
    function app() {
        return {
            theme: 'light',
            clients: [],
            manualClients: [],
            groups: [],
            subnets: [],
            stats: {},
            form: {
                address: '',
                group_id: '',
                metadata: '',
                type: null,
                error: ''
            },

            init() {
                this.theme = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                this.loadAll();
                setTimeout(() => lucide.createIcons(), 100);
                this.startPolling();
            },

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.documentElement.classList.toggle('dark', this.theme === 'dark');
                setTimeout(() => lucide.createIcons(), 50);
            },

            startPolling() {
                setInterval(() => this.loadStats(), 10000);
            },

            async loadAll() {
                await Promise.all([
                    this.loadClients(),
                    this.loadGroups(),
                    this.loadStats(),
                    this.loadSubnets(),
                    this.loadManualClients()
                ]);
            },

            async loadClients() {
                try {
                    const res = await fetch('/api/clients?limit=1000');
                    if (res.ok) this.clients = await res.json();
                } catch (e) {
                    console.error('Failed to load clients:', e);
                }
            },

            async loadManualClients() {
                try {
                    const res = await fetch('/api/clients?limit=1000');
                    if (res.ok) {
                        const all = await res.json();
                        this.manualClients = all.filter(c => c.hostname || c.mac_address);
                    }
                } catch (e) {
                    console.error('Failed to load manual clients:', e);
                }
            },

            async loadGroups() {
                try {
                    const res = await fetch('/api/groups');
                    if (res.ok) this.groups = await res.json();
                } catch (e) {
                    console.error('Failed to load groups:', e);
                }
            },

            async loadStats() {
                try {
                    const res = await fetch('/api/clients/stats');
                    if (res.ok) this.stats = await res.json();
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            },

            async loadSubnets() {
                try {
                    const res = await fetch('/api/client-subnets');
                    if (res.ok) this.subnets = await res.json();
                } catch (e) {
                    console.error('Failed to load subnets:', e);
                }
            },

            getGroupName(id) {
                const g = this.groups.find(x => x.id === id);
                return g ? g.name : '-';
            },

            detectType() {
                const v = this.form.address.trim();
                this.form.error = '';

                if (!v) {
                    this.form.type = null;
                    return;
                }

                // Check CIDR
                if (v.includes('/')) {
                    if (this.isValidCIDR(v)) {
                        this.form.type = 'subnet';
                    } else {
                        this.form.type = null;
                        this.form.error = 'Invalid CIDR format (e.g., 192.168.1.0/24)';
                    }
                    return;
                }

                // Check MAC
                if (this.isValidMAC(v)) {
                    this.form.type = 'mac';
                    this.form.error = 'MAC detected! Please enter the IP address.';
                    return;
                }

                // Check IP
                if (this.isValidIP(v)) {
                    this.form.type = 'ip';
                } else {
                    this.form.type = null;
                    this.form.error = 'Invalid IP, CIDR or MAC address';
                }
            },

            isValidIP(ip) {
                const parts = ip.split('.');
                if (parts.length === 4) {
                    return parts.every(p => {
                        const num = parseInt(p, 10);
                        return p === num.toString() && num >= 0 && num <= 255;
                    });
                }
                return false;
            },

            isValidCIDR(cidr) {
                const parts = cidr.split('/');
                if (parts.length !== 2) return false;
                const prefix = parseInt(parts[1]);
                if (!this.isValidIP(parts[0])) return false;
                return prefix >= 0 && prefix <= 32;
            },

            isValidMAC(mac) {
                return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$|^[0-9A-Fa-f]{12}$/.test(mac);
            },

            getBadgeClass() {
                if (this.form.type === 'ip') return 'badge-ip';
                if (this.form.type === 'subnet') return 'badge-subnet';
                if (this.form.type === 'mac') return 'badge-mac';
                return '';
            },

            getTypeLabel() {
                const labels = {
                    'ip': 'IP Address â†’ Individual Client',
                    'subnet': 'CIDR Subnet â†’ Multiple Clients',
                    'mac': 'MAC Address â†’ Requires IP'
                };
                return labels[this.form.type] || '';
            },

            getButtonText() {
                if (!this.form.type) return 'Enter address...';
                if (this.form.type === 'mac') return 'Add IP address';
                return this.form.type === 'subnet' ? 'Add Subnet' : 'Add Client';
            },

            async submitForm() {
                if (!this.form.type) {
                    alert('Invalid address');
                    return;
                }

                if (this.form.type === 'mac') {
                    alert('MAC address detected! Please also enter the IP address.');
                    return;
                }

                if (this.form.error) {
                    alert(this.form.error);
                    return;
                }

                try {
                    if (this.form.type === 'subnet') {
                        await this.submitSubnet();
                    } else {
                        await this.submitClient();
                    }
                } catch (e) {
                    console.error('Submission error:', e);
                    alert('Error: ' + e.message);
                }
            },

            async submitClient() {
                const res = await fetch('/api/clients', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ip_address: this.form.address,
                        group_id: this.form.group_id ? parseInt(this.form.group_id) : null,
                        hostname: this.form.metadata || null,
                        mac_address: null
                    })
                });

                if (res.ok) {
                    this.resetForm();
                    await this.loadAll();
                    alert('Client added successfully!');
                } else {
                    const error = await res.text();
                    alert('Failed: ' + error);
                }
            },

            async submitSubnet() {
                const res = await fetch('/api/client-subnets', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subnet_cidr: this.form.address,
                        group_id: this.form.group_id ? parseInt(this.form.group_id) : null,
                        comment: this.form.metadata || null
                    })
                });

                if (res.ok) {
                    this.resetForm();
                    await this.loadAll();
                    alert('Subnet added successfully!');
                } else {
                    const error = await res.text();
                    alert('Failed: ' + error);
                }
            },

            resetForm() {
                this.form = {
                    address: '',
                    group_id: '',
                    metadata: '',
                    type: null,
                    error: ''
                };
            },

            async deleteClient(id) {
                if (!confirm('Delete this client?')) return;
                try {
                    const res = await fetch(`/api/clients/${id}`, {method: 'DELETE'});
                    if (res.ok) {
                        await this.loadAll();
                        alert('Client deleted!');
                    } else {
                        alert('Failed: ' + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error deleting client');
                }
            },

            async deleteSubnet(id) {
                if (!confirm('Delete this subnet?')) return;
                try {
                    const res = await fetch(`/api/client-subnets/${id}`, {method: 'DELETE'});
                    if (res.ok) {
                        await this.loadAll();
                        alert('Subnet deleted!');
                    } else {
                        alert('Failed: ' + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error deleting subnet');
                }
            },

            formatDateTime(timestamp) {
                if (!timestamp) return '-';
                return new Date(timestamp).toLocaleString();
            }
        }
    }
</script>

</body>
</html>
